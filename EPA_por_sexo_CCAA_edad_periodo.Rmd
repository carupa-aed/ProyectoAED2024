---
title: "EPA por sexo CCAA edad periodo"
author: "Marcos"
date: "2024-10-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(plotly)) install.packages("plotly")
if(!require(readr)) install.packages("readr")
if(!require(sf)) install.packages("sf")
if(!require(patchwork)) install.packages("patchwork")
```

```{r}
rm(list = ls())

# https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65285.csv?nocab=1
# Población total
Poblacion <- read_delim("data/Poblacion Total.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Activos
Activos <- read_delim("data/Activos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Inactivos
Inactivos <- read_delim("data/Inactivos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Ocupados
Ocupados <- read_delim("data/Ocupados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Parados
Parados <- read_delim("data/Parados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
```

```{r}
Poblacion_edad_trabajar <- Poblacion %>%
  rename(`Población en edad de trabajar` = `Total`) %>%
  filter(Edad != "Menores de 16") %>%
  select(-contains("Total Nacional")) %>%
  mutate(`Comunidades y Ciudades Autónomas` = replace_na(`Comunidades y Ciudades Autónomas`, "Total Nacional"))

Activos <- Activos %>%
  rename(`Activos` = `Total`)

Inactivos <- Inactivos %>%
  rename(`Inactivos` = `Total`)

Ocupados <- Ocupados %>%
  rename(`Ocupados` = `Total`)
  
Parados <- Parados %>%
  rename(`Parados` = `Total`)
```

```{r}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Población en edad de trabajar` = sum(`Población en edad de trabajar`, na.rm = TRUE), .groups = 'drop')

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Inactivos` = sum(`Inactivos`, na.rm = TRUE), .groups = 'drop')
```

```{r}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Activos <- Activos %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Ocupados <- Ocupados %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Parados <- Parados %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)
```

```{r}
# Almacenamos todos los datasets en uno
datos <- Poblacion_edad_trabajar %>%
  mutate(Activos = Activos$Activos) %>%
  mutate(Inactivos = Inactivos$Inactivos) %>%
  mutate(Ocupados = Ocupados$Ocupados) %>%
  mutate(Parados = Parados$Parados) %>%
  filter(`Comunidades y Ciudades Autónomas` != "Total Nacional") %>%
  separate(`Comunidades y Ciudades Autónomas`, into = c("Codigo", "Comunidades y Ciudades Autónomas"), sep = " ", extra = "merge")


sacarFechas <- function(x) {
  año <- as.numeric(substr(x, 1, 4))
  trimestre <- substr(x, 6, 6)
  mes <- switch(trimestre, "1" = "03", "2" = "06", "3" = "09", "4" = "12")
  paste(año, mes, "01", sep = "-")
}

datos$Periodo <- as.Date(sapply(datos$Periodo, sacarFechas), format = "%Y-%m-%d")


# Borramos los datasets innecesarios
rm(list = setdiff(ls(), "datos"))
```

# Creación de tasas
```{r}
datos <- datos %>%
  mutate(`Tasa de Actividad` = (datos$Activos/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Inactividad` = (datos$Inactivos/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Ocupación` = (datos$Ocupados/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Empleo` = (datos$Ocupados/datos$Activos)*100) %>%
  mutate(`Tasa de Desempleo` = (datos$Parados/datos$Activos)*100)
```

```{r}
# Cargar el archivo GeoJSON (ajusta la ruta a tu archivo)
geojson_path <- "./data/spain-communities.geojson"
mapa_comunidades <- st_read(geojson_path)
```


```{r}
# Lista de tasas para iterar
tasas <- c("Tasa de Empleo", "Tasa de Actividad", "Tasa de Ocupación")

# Función para calcular clustering y generar gráficos y mapas
crear_clustering_grafico_mapa <- function(tasa, mapa_comunidades) {
  
  # Calcular la media de la tasa seleccionada por comunidad
  dataset_2007 <- datos %>%
    filter(format(Periodo, "%Y") == "2007") %>%
    group_by(Codigo, `Comunidades y Ciudades Autónomas`) %>%
    summarise(TasaMedia = mean(.data[[tasa]], na.rm = TRUE), .groups = "drop")
  
  # Escalar la tasa
  dataset_scaled <- scale(dataset_2007$TasaMedia)
  
  # Aplicar clustering
  set.seed(123)
  kmeans_result <- kmeans(dataset_scaled, centers = 3)
  
  # Añadir los clusters al dataset
  dataset_2007$Cluster <- as.factor(kmeans_result$cluster)
  
  # Reordenar los clusters basándose en los valores de TasaMedia
  cluster_ordenado <- dataset_2007 %>%
    group_by(Cluster) %>%
    summarise(TasaPromedio = mean(TasaMedia)) %>%
    arrange(TasaPromedio) %>%
    mutate(ClusterOrdenado = factor(Cluster, levels = Cluster[order(TasaPromedio)]))
  
  # Mapear los nuevos clusters ordenados al dataset original
  dataset_2007 <- dataset_2007 %>%
    left_join(cluster_ordenado, by = "Cluster") %>%
    mutate(Cluster = ClusterOrdenado)
  
  # Crear gráfico de barras agrupadas por cluster
  grafico_barras <- ggplot(dataset_2007, aes(x = reorder(`Comunidades y Ciudades Autónomas`, TasaMedia), 
                                             y = TasaMedia, fill = Cluster)) +
    geom_col() +
     geom_text(aes(label = round(TasaMedia, 1)), # Añadir los valores
              hjust = 1, # Ajustar la posición del texto fuera de la barra
              size = 3) +  # Tamaño del texto
    coord_flip() +
    labs(
      x = "Comunidades Autónomas",
      y = paste(tasa, "(%)"),
      fill = "Cluster"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Unir el dataset con el GeoJSON
  mapa <- mapa_comunidades %>%
    left_join(dataset_2007, by = c("cod_ccaa" = "Codigo"))
  
  # Crear el mapa
  mapa_clustering <- ggplot(mapa) +
    geom_sf(aes(fill = Cluster)) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Combinar ambos gráficos con patchwork
  combinado <- grafico_barras + mapa_clustering + 
    plot_layout(ncol = 2) + # Disposición en una sola columna
    plot_annotation(title = paste("Análisis de Clustering y Mapa para", tasa, "(2007)"))
  
  # Mostrar el gráfico combinado
  print(combinado)
}

# Iterar sobre todas las tasas y generar los gráficos y mapas
for (tasa in tasas) {
  crear_clustering_grafico_mapa(tasa, mapa_comunidades)
}
```

```{r}
# Lista de tasas para iterar
tasas <- c("Tasa de Empleo", "Tasa de Actividad", "Tasa de Ocupación")

# Función para calcular clustering y generar gráficos y mapas
crear_clustering_grafico_mapa <- function(tasa, mapa_comunidades) {
  
  # Calcular la media de la tasa seleccionada por comunidad
  dataset_2013 <- datos %>%
    filter(format(Periodo, "%Y") == "2013") %>%
    group_by(Codigo, `Comunidades y Ciudades Autónomas`) %>%
    summarise(TasaMedia = mean(.data[[tasa]], na.rm = TRUE), .groups = "drop")
  
  # Escalar la tasa
  dataset_scaled <- scale(dataset_2013$TasaMedia)
  
  # Aplicar clustering
  set.seed(123)
  kmeans_result <- kmeans(dataset_scaled, centers = 3)
  
  # Añadir los clusters al dataset
  dataset_2013$Cluster <- as.factor(kmeans_result$cluster)
  
  # Reordenar los clusters basándose en los valores de TasaMedia
  cluster_ordenado <- dataset_2013 %>%
    group_by(Cluster) %>%
    summarise(TasaPromedio = mean(TasaMedia)) %>%
    arrange(TasaPromedio) %>%
    mutate(ClusterOrdenado = factor(Cluster, levels = Cluster[order(TasaPromedio)]))
  
  # Mapear los nuevos clusters ordenados al dataset original
  dataset_2013 <- dataset_2013 %>%
    left_join(cluster_ordenado, by = "Cluster") %>%
    mutate(Cluster = ClusterOrdenado)
  
  # Crear gráfico de barras agrupadas por cluster
  grafico_barras <- ggplot(dataset_2013, aes(x = reorder(`Comunidades y Ciudades Autónomas`, TasaMedia), 
                                             y = TasaMedia, fill = Cluster)) +
    geom_col() +
     geom_text(aes(label = round(TasaMedia, 1)), # Añadir los valores
              hjust = 1, # Ajustar la posición del texto fuera de la barra
              size = 3) +  # Tamaño del texto
    coord_flip() +
    labs(
      x = "Comunidades Autónomas",
      y = paste(tasa, "(%)"),
      fill = "Cluster"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Unir el dataset con el GeoJSON
  mapa <- mapa_comunidades %>%
    left_join(dataset_2013, by = c("cod_ccaa" = "Codigo"))
  
  # Crear el mapa
  mapa_clustering <- ggplot(mapa) +
    geom_sf(aes(fill = Cluster)) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Combinar ambos gráficos con patchwork
  combinado <- grafico_barras + mapa_clustering + 
    plot_layout(ncol = 2) + # Disposición en una sola columna
    plot_annotation(title = paste("Análisis de Clustering y Mapa para", tasa, "(2013)"))
  
  # Mostrar el gráfico combinado
  print(combinado)
}

# Iterar sobre todas las tasas y generar los gráficos y mapas
for (tasa in tasas) {
  crear_clustering_grafico_mapa(tasa, mapa_comunidades)
}
```

```{r}
# Lista de tasas para iterar
tasas <- c("Tasa de Empleo", "Tasa de Actividad", "Tasa de Ocupación")

# Función para calcular clustering y generar gráficos y mapas
crear_clustering_grafico_mapa <- function(tasa, mapa_comunidades) {
  
  # Calcular la media de la tasa seleccionada por comunidad
  dataset_2019 <- datos %>%
    filter(format(Periodo, "%Y") == "2019") %>%
    group_by(Codigo, `Comunidades y Ciudades Autónomas`) %>%
    summarise(TasaMedia = mean(.data[[tasa]], na.rm = TRUE), .groups = "drop")
  
  # Escalar la tasa
  dataset_scaled <- scale(dataset_2019$TasaMedia)
  
  # Aplicar clustering
  set.seed(123)
  kmeans_result <- kmeans(dataset_scaled, centers = 3)
  
  # Añadir los clusters al dataset
  dataset_2019$Cluster <- as.factor(kmeans_result$cluster)
  
  # Reordenar los clusters basándose en los valores de TasaMedia
  cluster_ordenado <- dataset_2019 %>%
    group_by(Cluster) %>%
    summarise(TasaPromedio = mean(TasaMedia)) %>%
    arrange(TasaPromedio) %>%
    mutate(ClusterOrdenado = factor(Cluster, levels = Cluster[order(TasaPromedio)]))
  
  # Mapear los nuevos clusters ordenados al dataset original
  dataset_2019 <- dataset_2019 %>%
    left_join(cluster_ordenado, by = "Cluster") %>%
    mutate(Cluster = ClusterOrdenado)
  
  # Crear gráfico de barras agrupadas por cluster
  grafico_barras <- ggplot(dataset_2019, aes(x = reorder(`Comunidades y Ciudades Autónomas`, TasaMedia), 
                                             y = TasaMedia, fill = Cluster)) +
    geom_col() +
     geom_text(aes(label = round(TasaMedia, 1)), # Añadir los valores
              hjust = 1, # Ajustar la posición del texto fuera de la barra
              size = 3) +  # Tamaño del texto
    coord_flip() +
    labs(
      x = "Comunidades Autónomas",
      y = paste(tasa, "(%)"),
      fill = "Cluster"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Unir el dataset con el GeoJSON
  mapa <- mapa_comunidades %>%
    left_join(dataset_2019, by = c("cod_ccaa" = "Codigo"))
  
  # Crear el mapa
  mapa_clustering <- ggplot(mapa) +
    geom_sf(aes(fill = Cluster)) +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Combinar ambos gráficos con patchwork
  combinado <- grafico_barras + mapa_clustering + 
    plot_layout(ncol = 2) + # Disposición en una sola columna
    plot_annotation(title = paste("Análisis de Clustering y Mapa para", tasa, "(2019)"))
  
  # Mostrar el gráfico combinado
  print(combinado)
}

# Iterar sobre todas las tasas y generar los gráficos y mapas
for (tasa in tasas) {
  crear_clustering_grafico_mapa(tasa, mapa_comunidades)
}
```

















```{r}
# Filtrar los datos para Andalucía y edad de 16 a 19 años
data_filtered <- datos %>%
  filter(Sexo == "Hombres" &
         `Comunidades y Ciudades Autónomas` %in% c("Andalucía", "Navarra, Comunidad Foral de", "Comunitat Valenciana", "Melilla") &
         Edad == "De 25 a 34 años")

# Crear el gráfico
ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = `Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  labs(title = "Evolución de la Tasa de Ocupación (25-34 años)",
       x = "Periodo",
       y = "Tasa de Ocupación") +
  theme_minimal()
```

```{r}
# Filtrar los datos para Andalucía y edad de 16 a 19 años
data_filtered <- datos %>%
  filter(Sexo %in% c("Hombres", "Mujeres"),
         `Comunidades y Ciudades Autónomas` == "Andalucía" &
         Edad == "De 16 a 19 años")

# Calcular la diferencia de Tasa de Actividad entre Hombres y Mujeres
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Actividad`[Sexo == "Hombres"] - `Tasa de Actividad`[Sexo == "Mujeres"],
            .groups = 'drop')

# Crear el gráfico
ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Actividad`)) +
  geom_line(aes(colour = Sexo)) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia))
  labs(title = "Evolución de la Tasa de Actividad en Andalucía (16-19 años)",
       x = "Periodo",
       y = "Tasa de Actividad") +
  theme_minimal()

```

