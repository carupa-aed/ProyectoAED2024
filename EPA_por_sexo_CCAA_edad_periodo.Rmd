---
title: "EPA por sexo CCAA edad periodo"
author: "Marcos"
date: "2024-10-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("readr")
library("dplyr")
library("tidyr")
library("ggplot2")
```

```{r}
rm(list = ls())

# https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65285.csv?nocab=1
# Población total
Poblacion <- read_delim("data/Poblacion Total.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Activos
Activos <- read_delim("data/Activos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Inactivos
Inactivos <- read_delim("data/Inactivos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Ocupados
Ocupados <- read_delim("data/Ocupados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Parados
Parados <- read_delim("data/Parados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
```

```{r}
Poblacion_edad_trabajar <- Poblacion %>%
  rename(`Población en edad de trabajar` = `Total`) %>%
  filter(Edad != "Menores de 16") %>%
  select(-contains("Total Nacional")) %>%
  mutate(`Comunidades y Ciudades Autónomas` = replace_na(`Comunidades y Ciudades Autónomas`, "Total Nacional"))

Activos <- Activos %>%
  rename(`Activos` = `Total`)

Inactivos <- Inactivos %>%
  rename(`Inactivos` = `Total`)

Ocupados <- Ocupados %>%
  rename(`Ocupados` = `Total`)
  
Parados <- Parados %>%
  rename(`Parados` = `Total`)
```

```{r}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Población en edad de trabajar` = sum(`Población en edad de trabajar`, na.rm = TRUE), .groups = 'drop')

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Inactivos` = sum(`Inactivos`, na.rm = TRUE), .groups = 'drop')
```

```{r}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Activos <- Activos %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Ocupados <- Ocupados %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)

Parados <- Parados %>%
  mutate(Edad = ifelse(Edad == "55 y más años", "De 55 y más años", Edad)) %>%
  arrange(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo)
```

```{r}
# Almacenamos todos los datasets en uno
datos <- Poblacion_edad_trabajar %>%
  mutate(Activos = Activos$Activos) %>%
  mutate(Inactivos = Inactivos$Inactivos) %>%
  mutate(Ocupados = Ocupados$Ocupados) %>%
  mutate(Parados = Parados$Parados) %>%
  mutate(`Comunidades y Ciudades Autónomas` = gsub("^\\d{2} ", "", `Comunidades y Ciudades Autónomas`))

sacarFechas <- function(x) {
  año <- as.numeric(substr(x, 1, 4))
  trimestre <- substr(x, 6, 6)
  mes <- switch(trimestre, "1" = "03", "2" = "06", "3" = "09", "4" = "12")
  paste(año, mes, "01", sep = "-")
}

datos$Periodo <- as.Date(sapply(datos$Periodo, sacarFechas), format = "%Y-%m-%d")


# Borramos los datasets innecesarios
rm(list = setdiff(ls(), "datos"))
```

# Creación de tasas
```{r}
datos <- datos %>%
  mutate(`Tasa de Actividad` = (datos$Activos/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Inactividad` = (datos$Inactivos/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Ocupación` = (datos$Ocupados/datos$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Empleo` = (datos$Ocupados/datos$Activos)*100) %>%
  mutate(`Tasa de Desempleo` = (datos$Parados/datos$Activos)*100)
```

```{r}
# Filtrar los datos para Andalucía y edad de 16 a 19 años
data_filtered <- datos %>%
  filter(Sexo == "Hombres" &
         `Comunidades y Ciudades Autónomas` %in% c("Andalucía", "Navarra, Comunidad Foral de", "Comunitat Valenciana", "Melilla") &
         Edad == "De 25 a 34 años")

# Crear el gráfico
ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = `Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  labs(title = "Evolución de la Tasa de Ocupación en Andalucía (25-34 años)",
       x = "Periodo",
       y = "Tasa de Ocupación") +
  theme_minimal()
```

```{r}
# Filtrar los datos para Andalucía y edad de 16 a 19 años
data_filtered <- datos %>%
  filter(Sexo %in% c("Hombres", "Mujeres"),
         `Comunidades y Ciudades Autónomas` == "Andalucía" &
         Edad == "De 16 a 19 años")

# Calcular la diferencia de Tasa de Actividad entre Hombres y Mujeres
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Actividad`[Sexo == "Hombres"] - `Tasa de Actividad`[Sexo == "Mujeres"],
            .groups = 'drop')

# Crear el gráfico
ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Actividad`)) +
  geom_line(aes(colour = Sexo)) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia))
  labs(title = "Evolución de la Tasa de Actividad en Andalucía (16-19 años)",
       x = "Periodo",
       y = "Tasa de Actividad") +
  theme_minimal()

```

