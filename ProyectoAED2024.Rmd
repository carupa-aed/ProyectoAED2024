---
title: 'Análisis del mercado laboral en España'
author:
  - name: Catret Ruber, Pablo
    affil: 1
  - name: Palazón Caballero, José Miguel
    affil: 1
  - name: Rosique Martínez, Marcos
    affil: 1
affiliation:
  - num: 1
    address: |
      Universitat de València - 
      Escola Tècnica Superior d'Enginyeria (ETSE)
      Avinguda de l'Universitat, 46100 Burjassot, Valencia
    
# author citation list in chicago format
authorcitation: |
  Catret Ruber, P.; Palazón Caballero, J.M.; Rosique Martínez, M.
correspondence: |
  jomipaca@alumni.uv.es.; rosique2@alumni.uv.es
# document options
journal: Universitat de València
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |
  A single paragraph of about 200 words maximum. For research articles, 
  abstracts should give a pertinent overview of the work. We strongly encourage
  authors to use the following style of structured abstracts, but without 
  headings: 1) Background: Place the question addressed in a broad context and
  highlight the purpose of the study; 2) Methods: Describe briefly the main
  methods or treatments applied; 3) Results: Summarize the article's main 
  findings; and 4) Conclusion: Indicate the main conclusions or interpretations. 
  The abstract should be an objective representation of the article, it must not 
  contain results which are not presented and substantiated in the main text and 
  should not exaggerate the main conclusions.
# back matter
keywords: |
  Mercado laboral; Tasa; Clustering; Pandemia COVID-19; Análisis exploratorio de datos
bibliography: mybibfile.bib
#appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r, include=FALSE}
if(!require(knitr)) install.packages("knitr")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(plotly)) install.packages("plotly")
if(!require(readr)) install.packages("readr")
if(!require(sf)) install.packages("sf")
if(!require(patchwork)) install.packages("patchwork")
if(!require(stats)) install.packages("stats")
if(!require(treemapify)) install.packages("treemapify")
if(!require(reshape2)) install.packages("reshape2")
if(!require(scales)) install.packages("scales")
if(!require(transformr)) install.packages("transformr")
if(!require(gganimate)) install.packages("gganimate")
if(!require(visdat)) install.packages("visdat")
if(!require(treemap)) install.packages("treemap")
if(!require(stringr)) install.packages("stringr")
if(!require(tibble)) install.packages("tibble")
if(!require(kableExtra)) install.packages("kableExtra")


# Cargar funciones desde el archivo functions.r
source("functions.r")
```

# Introducción

El mercado laboral en España es un sistema complejo y dinámico que refleja las interacciones entre diversos factores económicos, sociales y demográficos. Este trabajo de análisis exploratorio de datos combina dos pilares fundamentales para entender las dinámicas laborales: la Encuesta de Población Activa (EPA) y la Clasificación Nacional de Actividades Económicas (CNAE-2009). A través de estas fuentes, se busca ofrecer una visión integral de las tasas de empleo, actividad y ocupación, desglosadas por género, grupo de edad y comunidad autónoma, así como por ramas de actividad económica.

La EPA, realizada trimestralmente por el Instituto Nacional de Estadística (INE), proporciona información detallada sobre la participación laboral de la población, permitiendo analizar las diferencias en el acceso al empleo según el género, la edad y el territorio. En esta parte del estudio, se examinan las tasas del mercado laboral en las distintas comunidades autónomas y cómo estas se ven influenciadas por eventos como la crisis financiera de 2008 o la pandemia de COVID-19. Además, se busca identificar desigualdades estructurales y dinámicas regionales que puedan servir como base para estudios más específicos o el diseño de políticas públicas.

Por otro lado, la CNAE-2009 aporta un marco estándar para clasificar las actividades económicas en las que se desempeñan los trabajadores, permitiendo analizar cómo se distribuye la fuerza laboral entre diferentes sectores. Este enfoque complementario permite explorar no solo el "dónde" y "quién" trabaja, sino también el "en qué" trabaja la población, revelando patrones de especialización sectorial y el impacto de la transformación económica a lo largo de los años.

La combinación de ambas perspectivas —la distribución demográfica y regional desde la EPA y la estructura sectorial desde la CNAE— permite abordar preguntas clave sobre el mercado laboral, tales como:

- ¿Cómo varía la participación laboral entre comunidades autónomas?
- ¿Cómo varía la participación laboral entre grupos de edad?
- ¿Qué sectores han experimentado los mayores cambios tras eventos históricos como la crisis de 2008 o la pandemia de COVID-19?

Este análisis exploratorio busca no solo describir el estado actual del mercado laboral en España, sino también identificar tendencias, desigualdades y oportunidades de mejora. El objetivo final es proporcionar una base sólida para futuros estudios y contribuir al diseño de estrategias efectivas en el ámbito económico, social y político.


# Importación y tratamiento de datos

En primer lugar, se han descargado los datos directamente desde la base de datos abierta INE Base. Estos datos se presentan en un formato de csv, separado por el carácter ';', y con el uso de marca de decimales española ','.

## **Encuesta de Población Activa (EPA)**

Como se ha mencionado anteriormente en la introducción, la EPA es realizada trimestralmente por el Instituto Nacional de Estadística, por lo que se han extraído cinco datasets de su base de datos: población total, activa, inactiva, ocupada y parada. 

Cabe destacar que estos datasets están desglosados por comunidad y ciudad autónoma, sexo y grupo de edad, con las tres columnas expresadas en "miles de personas" como unidad. El periodo de los datos figura desde el primer trismestre de 2002 hasta el tercer trimestre de 2024.

```{r, warning=FALSE, include=FALSE}
Poblacion <- read_delim("data/Poblacion Total.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

Activos <- read_delim("data/Activos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Activos <- Activos %>% rename(`Activos` = `Total`)

Inactivos <- read_delim("data/Inactivos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Inactivos <- Inactivos %>% rename(`Inactivos` = `Total`)

Ocupados <- read_delim("data/Ocupados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Ocupados <- Ocupados %>% rename(`Ocupados` = `Total`)

Parados <- read_delim("data/Parados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Parados <- Parados %>% rename(`Parados` = `Total`)
```

Al tratarse de un análisis del mercado laboral eliminaremos al grupo de población menor a 16 años pues no tienen edad suficiente para trabajar. Notamos que en el dataset Población hay una columna que solo contiene la cadena "Total Nacional", por lo que la eliminamos. Además, en la columna "Comunidades y Ciudades Autónomas" hay valores faltantes que coinciden con las filas del propio Total Nacional, de modo que los completamos con dicha cadena.

```{r, include=FALSE}
Poblacion_edad_trabajar <- Poblacion %>%
  rename(`Población en edad de trabajar` = `Total`) %>%
  filter(Edad != "Menores de 16") %>%
  select(-contains("Total Nacional")) %>%
  mutate(`Comunidades y Ciudades Autónomas` =
           replace_na(`Comunidades y Ciudades Autónomas`, "Total Nacional"))
```

Notamos que para el conjunto de datos de población total en edad de trabajar y población inactiva hay un intervalo de edad más que para el resto de datasets: se divide l"55 y más años" en los grupos "De 55 a 64 años" y "65 y más años". Dado que buscamos obtener un dataset único y compacto uniremos ambos grupos de edad como en el resto de datasets. Una vez normalizada la estructura de los datasets podemos unificar todas las tablas en una sola.

```{r, include=FALSE}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Población en edad de trabajar` = 
              sum(`Población en edad de trabajar`, na.rm = TRUE), .groups = 'drop')

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Inactivos` = sum(`Inactivos`, na.rm = TRUE), .groups = 'drop')
```

```{r, include=FALSE}
datos_EPA <- left_join(Poblacion_edad_trabajar, Activos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Inactivos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Ocupados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Parados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo"))
```

Otra circunstancia a corregir que los datos de la columna "Periodo" son cadenas; para solucionarlo, definimos y empleamos la función "SacarFechas" para transformarlos a tipo Date. Una vez corregido, comprobaremos si existen datos faltantes en nuestro dataset.

```{r, include=FALSE}
datos_EPA$Periodo <- as.Date(sapply(datos_EPA$Periodo, sacarFechas), 
                             format = "%Y-%m-%d")
```

```{r, include=FALSE}
# Borramos los datasets innecesarios
rm(list = c("Poblacion", "Poblacion_edad_trabajar", "Activos", "Inactivos", 
            "Ocupados", "Parados"))
```

```{r, echo=FALSE}
# Calcular valores faltantes
tabla_faltantes <- sapply(datos_EPA, function(NAs) sum(is.na(NAs))) %>%
  as.data.frame() %>%  # Convertir a data frame
  rownames_to_column("Variable")  # Mover nombres de fila a columna

# Cambiar el nombre de la columna
colnames(tabla_faltantes)[2] <- "Valores faltantes"

# Mostrar la tabla con kable
kable(tabla_faltantes, caption = "Frecuencias de datos faltantes en el conjunto de datos EPA")

```

Existe únicamente un porcentaje muy bajo de valores faltantes entre las columnas "Activos", "Ocupados" y "Parados". Veamos un ejemplo de estos casos.

```{r, echo=FALSE}
# Generar los datos filtrados
miss_datos_EPA <- datos_EPA %>% 
  mutate(miss_parados = is.na(Parados)) %>% 
  mutate(miss_ocupados = is.na(Ocupados)) %>%
  mutate(miss_activos = is.na(Activos)) %>%
  filter(miss_parados == TRUE | miss_ocupados == TRUE | miss_activos == TRUE)

# Tabla de comunidades autónomas
tabla_comunidades <- as.data.frame(table(miss_datos_EPA$`Comunidades y Ciudades Autónomas`)) %>%
  rename(Comunidad = Var1, `Valores faltantes` = Freq)

# Tabla de grupos de edad
tabla_edades <- as.data.frame(table(miss_datos_EPA$Edad)) %>%
  rename(`Grupo de edad` = Var1, `Valores faltantes` = Freq)

# Mostrar las tablas con kable
kable(tabla_comunidades, caption = "Frecuencias de datos faltantes por Comunidad Autónoma en el conjunto de datos EPA")

kable(tabla_edades, caption = "Frecuencias de datos faltantes por edad en el conjunto de datos EPA")

```

Los datos se concentran en Comunidades y Ciudades Autónomas con proporcionalmente poca población y en rangos de edades donde es poco habitual estar ocupado (ya que para que se cumpla dicha condición se debe estar buscando activamente trabajo). De hecho, el único valor que podría resultar extraño es que exista un valor faltante para un Total de edades, pero al comprobar la localización y fecha notamos que es razonable.

```{r, echo=FALSE}
kable(miss_datos_EPA[miss_datos_EPA$Edad == "Total",
               c("Sexo", "Comunidades y Ciudades Autónomas", "Periodo")], caption = "Valor faltante en el total de edades en el conjunto de datos EPA")
```

```{r, include=FALSE}
rm(list=c("miss_datos_EPA"))
```

Dicho patrón parece reflejar que muy poca población de esas características se encontraba parada; por tanto, sustituiremos los valores faltantes del dataset por ceros.

```{r, include=FALSE}
datos_EPA <- datos_EPA %>% 
  mutate(Parados = ifelse(is.na(Parados), 0, Parados)) %>%
  mutate(Ocupados = ifelse(is.na(Ocupados), 0, Ocupados)) %>%
  mutate(Activos = ifelse(is.na(Activos), 0, Activos))
```

## **Clasificación Nacional de Actividades Económicas (CNAE-2009)**

Este dataset divide los datos según rama de actividad, sexo y fecha en el periodo comprendido entre el primer trimestre de 2008 y el tercer trimestre de 2024, usando las mismas unidades que en el resto de datasets. No obstante, en este caso podemos encontrar los datos segmentado en dos subconjuntos principales:

+ Porcentajes ("Total_abs"): Representan la proporción de ocupación de cada rama de actividad con respecto al total del sexo correspondiente.

+ Valores absolutos ("Total_porc"): Proporcionan el número total de empleados en cada rama.

Esta separación permite analizar tanto las tendencias globales (valores absolutos) como la estructura relativa de los sectores (porcentajes).

```{r, include=FALSE}
datos_CNAE <- read.csv("data/CNAE.csv", sep=";", dec=",")
datos_CNAE$Total <- as.numeric(gsub(",", ".", gsub("\\.", "", datos_CNAE$Total)))
```

Nos encontramos de nuevo con el problema del formato de las fechas, por lo que volveremos a aplicar la función SacarFechas. Además, para diferenciar entre cada tipo de dato (valor absoluto y porcentaje) vamos a extraerlos en dos datasets para posteriormente realizar un join, esencialmente como si se realizara un pivote. Una vez hemos unificado la tabla es recomendable realizar un análisis de datos faltantes.

```{r, include=FALSE}
datos_CNAE$Periodo <- as.Date(sapply(datos_CNAE$Periodo, sacarFechas), format = "%Y-%m-%d")
```

```{r, include=FALSE}
datos_CNAE_porc <- datos_CNAE[datos_CNAE$Unidad=="Porcentaje",]
datos_CNAE_porc <- datos_CNAE_porc[, !names(datos_CNAE_porc) %in% "Unidad"]

datos_CNAE_abs <- datos_CNAE[datos_CNAE$Unidad=="Valor absoluto",]
datos_CNAE_abs <- datos_CNAE_abs[, !names(datos_CNAE_abs) %in% "Unidad"]

if (dim(datos_CNAE_abs)[1] == dim(datos_CNAE_porc)[1] & dim(datos_CNAE_abs)[2] == dim(datos_CNAE_porc)[2]){
  datos_CNAE <- left_join(datos_CNAE_abs, datos_CNAE_porc, 
                      by = c("Rama.de.actividad.CNAE.2009", "Sexo", "Periodo"), 
                      suffix = c("_abs", "_porc"))
}
```

```{r, include=FALSE}
rm(list = c("datos_CNAE_abs", "datos_CNAE_porc"))
```

```{r, echo=FALSE}
# Calcular valores faltantes
tabla_faltantes <- sapply(datos_CNAE, function(NAs) sum(is.na(NAs))) %>%
  as.data.frame() %>%  # Convertir a data frame
  rownames_to_column("Variable")  # Mover nombres de fila a columna

# Cambiar el nombre de la columna
colnames(tabla_faltantes)[2] <- "Valores faltantes"

# Mostrar la tabla con kable
kable(tabla_faltantes, caption = "Frecuencias de datos faltantes en el conjunto de datos CNAE")
```

Observamos que para un pequeño subconjunto de filas no existen cifras totales. Veamos si siguen algún patrón.

```{r, echo=FALSE}
# Filtrar datos con valores faltantes
miss_datos_CNAE <- datos_CNAE %>%
  mutate(miss_total = is.na(Total_abs)) %>%
  filter(miss_total == TRUE)

# Extraer las actividades únicas y renombrar la columna
tabla_actividades <- data.frame(Rama_de_actividad = unique(miss_datos_CNAE$Rama.de.actividad.CNAE.2009)[1:4])

# Mostrar la tabla con kable
kable(tabla_actividades, col.names = "Rama de actividad", caption = "Primeras cuatro actividades con valores faltantes en Total_abs")
```

```{r, include=FALSE}
rm(list=c("miss_datos_CNAE"))
```

Notamos que los valores faltantes se encuentran en ramas de actividades poco comunes relacionadas con la industria pesada, por lo que dichos NA reflejarán que muy poca población se dedica a ello, probablemente menos del mínimo registrable; en consecuencia sustituiremos dichos valores por ceros.

```{r, include=FALSE}
datos_CNAE <- datos_CNAE %>% 
  mutate(Total_abs = ifelse(is.na(Total_abs), 0, Total_abs)) %>% 
  mutate(Total_porc = ifelse(is.na(Total_porc), 0, Total_porc))
```

Por último, añadiremos una columna que calcula la variación entre un periodo y el siguiente, lo que permitirá identificar momentos de cambio significativo en el mercado laboral, detectando tendencias positivas o negativas a lo largo del tiempo. Esto también permitirá ver de manera rápida la estacionalidad de la ocupación, sobre todo en ciertas ramas de actividad. Es importante mencionar que realizar las diferencias entre un periodo y el siguiente genera NAs para el primer periodo de cada rama, por lo que sustituiremos estos valores faltantes por ceros.

```{r, include=FALSE}
datos_CNAE$Diferencia_Total <- NA

for (sexo in unique(datos_CNAE$Sexo)) {
  for (rama in unique(datos_CNAE$Rama.de.actividad.CNAE.2009)) {
    subset <- datos_CNAE[datos_CNAE$Sexo == sexo & 
                        datos_CNAE$Rama.de.actividad.CNAE.2009 == rama, ]
    
    datos_CNAE$Diferencia_Total[datos_CNAE$Sexo == sexo & 
              datos_CNAE$Rama.de.actividad.CNAE.2009 == rama 
             & datos_CNAE$Periodo != min(datos_CNAE$Periodo)] <- 
      - diff(subset$Total_abs)
  }
}

datos_CNAE$Diferencia_Total[datos_CNAE$Periodo == min(datos_CNAE$Periodo)] <- 0
```

```{r, include=FALSE}
rm(list = c("subset"))
```


# Representación y análisis de datos

Una vez preparados, los datos se visualizan a través de gráficos y tasas que permiten interpretar patrones, tendencias y distribuciones de manera más clara y directa.

## **Encuesta de Población Activa (EPA)**

Las tasas del mercado de trabajo, como la de actividad, empleo y ocupación, son fundamentales para este análisis porque permiten comparar de forma clara y estandarizada las dinámicas laborales entre comunidades autónomas y grupos poblacionales. Estas métricas facilitan el estudio de tendencias temporales y desigualdades estructurales, como las brechas de género o regionales, que no serían evidentes al observar valores absolutos. Además, su uso es clave para identificar áreas críticas y evaluar el impacto de eventos económicos, como la crisis de 2008 o la pandemia de COVID-19, en la participación laboral de la población.

Por ello, las siguientes tasas quedan incorporadas dentro del dataset anteriormente mencionado:

+ Tasa de Actividad (TA) = $\frac{\text{Activos}}{\text{Población} \geq 16}\cdot100$

+ Tasa de Inactividad (TI) = $\frac{\text{Inactivos}}{\text{Población} \geq 16}\cdot100 = 1 - TA$

+ Tasa de Ocupación (TO) = $\frac{\text{Ocupados}}{\text{Población} \geq 16}\cdot100$

+ Tasa de Empleo (TE) = $\frac{\text{Ocupados}}{\text{Activos}}\cdot100$

+ Tasa de Desempleo (TD) = $\frac{\text{Parados}}{\text{Activos}}\cdot100 = 1 - TE$

```{r, include=FALSE}
datos_EPA <- datos_EPA %>%
  mutate(`Tasa de Actividad` = (datos_EPA$Activos/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Inactividad` = (datos_EPA$Inactivos/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Ocupación` = (datos_EPA$Ocupados/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Empleo` = (datos_EPA$Ocupados/datos_EPA$Activos)*100) %>%
  mutate(`Tasa de Desempleo` = (datos_EPA$Parados/datos_EPA$Activos)*100)
```

```{r, include=FALSE}
inicio_crisis <- as.Date("2008-01-01")   # Inicio de la crisis (enero 2008)
fin_crisis <- as.Date("2013-06-01")      # Fin de la crisis (junio 2013)
inicio_covid <- as.Date("2020-03-01")    # Inicio de COVID (marzo 2020)
```

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
# Crear un gráfico de lineas para la Tasa de Actividad
data_filtered <- datos_EPA %>%
  filter(Sexo == "Ambos sexos" &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad == "Total")

TA <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Actividad`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 48,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 48,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 46,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


# Crear un gráfico de lineas para la Tasa de Empleo
TE <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Empleo`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 70,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 85,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 70,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


# Crear un gráfico de lineas para la Tasa de Ocupación
TO <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 38,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 43,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 38,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado <- TA + TE + TO +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, echo=FALSE, warning=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución del mercado de trabajo en España", fig.pos="h"}
# Lo hacemos en dos chunks porque el código anterior muestra por pantalla 
#una tabla que no queremos mostrar
combinado
```


La figura 1 muestra la evolución de la tasa de actividad, empleo y ocupación en España desde 2002 hasta la actualidad, reflejando cambios asociados a eventos económicos y sociales. Entre 2002 y 2008, todas las tasas crecieron sostenidamente gracias a la bonanza económica, mientras que la crisis de 2008 provocó una fuerte caída en las tasas de empleo y ocupación, aunque la tasa de actividad se mantuvo estable hasta 2013. En ese periodo, el empleo cayó a niveles del 75%, evidenciando un desempleo superior al 25%.

Desde 2013, con signos de recuperación económica, las tasas de empleo y ocupación comenzaron a mejorar progresivamente, mientras que la tasa de actividad decreció ligeramente debido a factores como la reducción del abandono escolar. La pandemia de COVID-19 en 2020 generó caídas abruptas en todas las tasas, especialmente en la ocupación, aunque a partir de 2021 se observa una recuperación marcada por la reincorporación laboral y el dinamismo de sectores clave como el turismo y los servicios digitales.\newline

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución del mercado de trabajo por género en España", fig.pos="h"}
# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Filtrar los datos para Hombres y Mujeres a nivel nacional
data_filtered <- datos_EPA %>%
  filter(Sexo %in% c("Hombres", "Mujeres") &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad == "Total")

# Calcular la diferencia entre hombres y mujeres en la Tasa de Actividad
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Actividad`[Sexo == "Hombres"] - `Tasa de Actividad`[Sexo == "Mujeres"],
            .groups = 'drop')


TA_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Actividad`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 60, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 30,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 20,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 30,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Calcular la diferencia entre hombres y mujeres en la Tasa de Empleo
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Empleo`[Sexo == "Hombres"] - `Tasa de Empleo`[Sexo == "Mujeres"],
            .groups = 'drop')


TE_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Empleo`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 100, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 30,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 40,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Calcular la diferencia entre hombres y mujeres en la Tasa de Ocupación
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Ocupación`[Sexo == "Hombres"] - `Tasa de Ocupación`[Sexo == "Mujeres"],
            .groups = 'drop')


TO_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "right"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 60, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 22,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 15,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 22,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado2 <- TA_sexo + TE_sexo + TO_sexo +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo por Sexo",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, echo=FALSE, warning=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución del mercado de trabajo por género en España", fig.pos="h"}
combinado2
```

En cambio, la figura 2 muestra la evolución de las tasas de actividad, empleo y ocupación por género, evidenciando desigualdades y avances hacia la igualdad. La tasa de actividad masculina, aunque más alta, disminuyó entre 2008 y 2020, mientras que la femenina creció sostenidamente desde 2002, reduciendo la brecha de género del 20% al 8%. En la tasa de empleo, las diferencias son menores, ya que mide solo a la población activa, mientras que en la tasa de ocupación las disparidades son más evidentes al incluir a toda la población en edad de trabajar.

La pandemia de 2020 generó descensos significativos en todas las tasas, seguidos de una recuperación que refleja la resiliencia del mercado laboral. Este análisis resalta los avances hacia la igualdad laboral, aunque persisten desigualdades estructurales, especialmente en la población activa y su impacto en la ocupación.\newline

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución del mercado de trabajo por grupo de edad en España", fig.pos="h"}
# Crear un gráfico de líneas para cada grupo de edad
data_filtered <- datos_EPA %>%
  filter(Sexo == "Ambos sexos" &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad != "Total")


TA_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Actividad`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 90, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 33,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 36,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de líneas para cada grupo de edad
TE_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Empleo`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(20, 100, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = 1.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 40,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 30,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de líneas para cada grupo de edad
TO_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "right"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 80, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 30,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 50,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 50,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado3 <- TA_edad + TE_edad + TO_edad +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo por Edad",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, warning=FALSE, echo=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución del mercado de trabajo por grupo de edad en España", fig.pos="h"}
combinado3
```

Por último, referenciando a la figura 3 que desglosa la población por grupos de edad, se puede observar cómo los grupos de edad han experimentado dinámicas distintas en el mercado laboral. Los mayores de 35 a 54 años mantienen tasas de actividad superiores al 80 %, reflejando una integración estable. En contraste, los jóvenes de 16 a 24 años presentan tasas mucho más bajas, con un desempleo superior al 70 % en 2013, influido por la crisis en sectores como la construcción y el aumento de la escolarización.

Los grupos jóvenes también exhiben estacionalidad, especialmente en verano, cuando se incorporan al mercado laboral en sectores como la hostelería. Por otro lado, el grupo de 55 y más años presenta tasas de actividad y ocupación bajas debido a la jubilación, aunque esto no afecta de igual manera a la tasa de empleo, que excluye a los inactivos como los jubilados. \newpage

### **Clusterización por Comunidades y Ciudades Autónomas**

En este apartado del proyecto se va a proceder a realizar un clustering de la tasa de empleo para las distintas Comunidades y Ciudades Autónomas de España en los siguientes años: 2007, 2013 y 2023.
El principal motivo por el cual escogemos esta tasa se debe a que se mide como el porcentaje de personas ocupadas respecto a la población activa, es decir, las que se encuentran activamente en el mercado laboral.

Como método de clusterización se utilizará el k-means, que organiza los datos en grupos basados en su similitud. Este algoritmo comienza eligiendo un número de clusters (`k`) y seleccionando centroides iniciales al azar. Cada punto se asigna al cluster cuyo centroide está más cercano, y luego los centroides se recalculan como el promedio de los puntos en cada grupo.
Es un proceso que se repite hasta que los centroides dejan de cambiar o se alcanza un límite de iteraciones. Al finalizar, las comunidades quedan agrupadas en k clusters representando cada uno un conjunto de puntos con características similares, en este caso CCAA.

Por otro lado, para la selección del hiperparámetro `k` se opta por el método del codo. Este consiste en graficar la suma de cuadrados dentro del cluster (WSS) frente a distintos valores de `k`. El punto donde la disminución de WSS se ralentiza significativamente, formando un "codo", indica el número adecuado de clusters.\newline

```{r, include=FALSE}
# Eliminamos el total nacional puesto que ahora nos centramos en la CCAA
datos_EPA <- datos_EPA %>%
  filter(`Comunidades y Ciudades Autónomas` != "Total Nacional") %>%
  separate(`Comunidades y Ciudades Autónomas`, into = c("Codigo", "Comunidades y Ciudades Autónomas"), sep = " ", extra = "merge")
```

```{r, include=FALSE}
# Cargamos el archivo GeoJSON
geojson_path <- "./data/spain-communities.geojson"
mapa_comunidades <- st_read(geojson_path)
```

```{r, include=FALSE}
tasas <- c("Tasa de Actividad", "Tasa de Empleo", "Tasa de Ocupación")
```


```{r, warning=FALSE, echo=FALSE, out.width='40%', fig.align='center', fig.cap="Gráfico de codo global para la tasa de empleo", fig.pos="h"}
grafico_codo_global("Tasa de Empleo", datos_EPA)
```

Observando el gráfico de la figura 4, se puede considerar que el número de clusters a partir del cual la WSS se ralentiza es en `k=3`, pues es en donde se forma el "codo".

Posteriormente, y como se ha mencionado al principio del apartado, vamos a hacer un clustering con el objetivo de agrupar las CCAA según su tasa de empleo en distintos periodos. Posteriormente los colores de los clusters se representan en un mapa de España dividido por dichas regiones para visualizar de forma clara y efectiva los patrones espaciales. La intención de esta medida es identificar patrones regionales y analizar las diferencias en las dinámicas del mercado laboral a nivel territorial.\newline

```{r, warning=FALSE, echo=FALSE, out.width='90%', fig.align='center', fig.cap="Clusterización regional con 3 centroides para la tasa de empleo en España en 2007", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2007")
```

La figura 5 muestra el análisis de clustering de la tasa de empleo en España en 2007. Todas las comunidades de la península a excepción de Extremadura y Andalucía se agrupan en un clustering único debido a la similitud en su tasa, con valores superiores al 90% representando mercados laborales sólidos. Ceuta y Melilla, con tasas por debajo del 80%, pertenecen al clúster rojo, reflejando mayores desafíos laborales. El clúster verde, con tasas entre el 80% y el 85%, incluye las regiones de Extremadura, Andalucía y Canarias, que muestran estabilidad moderada. En conjunto, la figura evidencia claras disparidades regionales en el empleo respecto al sur del país antes de la crisis económica.\newline

```{r, echo=FALSE, out.width='90%', fig.align='center', fig.cap="Clusterización regional con 3 centroides para la tasa de empleo en España en 2013", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2013")
```

En cambio, la figura 6 muestra el análisis de clustering de la tasa de empleo en España en 2013, el peor momento de la crisis económica. En comparación con 2007, las tasas de empleo han disminuido significativamente en todas las comunidades autónomas, reflejando el impacto generalizado de la recesión. Mientras que en 2007 gran parte de la península estaba agrupada en un único clúster, en 2013 se observa una mayor dispersión. El clúster azul mantiene las tasas más altas, superiores al 70%, mientras que el clúster rojo refleja las más bajas, por debajo del 60%. Esto evidencia las desigualdades regionales acentuadas por la crisis.\newline

```{r, warning=FALSE, echo=FALSE, out.width='90%', fig.align='center', fig.cap="Clusterización regional con 3 centroides para la tasa de empleo en España en 2023", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2023")
```

En la actualidad, la figura 7 muestra una recuperación general en las tasas de empleo respecto a 2013, aunque persisten desigualdades regionales. El clúster azul, que representa la mitad norte de España (a excepción de Asturias), destaca con tasas superiores al 83%, reflejando un mercado laboral sólido en esta área. El clúster verde, que representa la mitad sur, presenta tasas intermedias entre el 74% y el 82%, reflejando una mayor estabilidad en el empleo, aunque todavía sin alcanzar la uniformidad observada antes de la crisis. Por el contrario, el clúster rojo, que incluye las ciudades de Ceuta y Melilla, presenta tasas inferiores al 70%, evidenciando desafíos laborales persistentes.

En conclusión, se evidencia una mejora general, pero con brechas regionales significativas.

## **Clasificación Nacional de Actividades Económicas (CNAE-2009)**


En primer lugar se analiza la distribución de peso de las ramas de actividad en el total de la población empleada. Además, se busca comparar la evolución y el cambio sufrido por la estructura laboral española desde el primer trimestre de 2008 y el tercer trimestre de 2024. Para ello se generan treemaps para los periodos inicial (2008T1) y final (2024T3) del análisis. Estos gráficos muestran cómo se distribuye el empleo entre las diferentes ramas económicas según su peso relativo.

```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=3, fig.cap="Distribución de las ramas de actividad en el primer trimestre de 2008 y el tercer trimestre de 2024."}
# Filtrado de los datos para 2024T3
datos_filtrados_2024 <- na.omit(datos_CNAE[datos_CNAE$Sexo == "Ambos sexos" &
                                           datos_CNAE$Periodo == "2024-09-01" &
                                           datos_CNAE$Rama.de.actividad.CNAE.2009 != "Total" &
                                           grepl("^[0-9]", datos_CNAE$Rama.de.actividad.CNAE.2009), ])

# Filtrado de los datos para 2008T1
datos_filtrados_2008 <- na.omit(datos_CNAE[datos_CNAE$Sexo == "Ambos sexos" &
                                           datos_CNAE$Periodo == "2008-03-01" &
                                           datos_CNAE$Rama.de.actividad.CNAE.2009 != "Total" &
                                           grepl("^[0-9]", datos_CNAE$Rama.de.actividad.CNAE.2009), ])

# Crear una columna con las etiquetas recortadas solo si Total_porc < 4
datos_filtrados_2024$Rama.abreviada <- ifelse(datos_filtrados_2024$Total_porc < 4,
                                               substring(datos_filtrados_2024$Rama.de.actividad.CNAE.2009, 1, 2),
                                               str_wrap(substring(datos_filtrados_2024$Rama.de.actividad.CNAE.2009, 1, 150), width = 16))

datos_filtrados_2008$Rama.abreviada <- ifelse(datos_filtrados_2008$Total_porc < 5,
                                               substr(datos_filtrados_2008$Rama.de.actividad.CNAE.2009, 1, 2),
                                               str_wrap(substring(datos_filtrados_2008$Rama.de.actividad.CNAE.2009, 1, 50), width = 16))

# Crear una escala de colores para asegurar que ambos gráficos tengan la misma paleta
escala_color <- scale_fill_gradient(low = "lightblue", high = "darkblue")

# Primer gráfico: Treemap para 2024T3 (con leyenda)
grafico_treemap_2024 <- ggplot(datos_filtrados_2024, aes(area = Total_porc, fill = Total_porc, label = paste(datos_filtrados_2024$Rama.abreviada, Total_porc, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_text(aes(label = ifelse(Total_porc > 1, paste(datos_filtrados_2024$Rama.abreviada, Total_porc, sep = "\n"), "")), 
                    colour = "white", 
                    place = "centre", 
                    size = 6) + 
  labs(title = "Distribución Rama de\nActividad (2024T3)") +
  escala_color

# Segundo gráfico: Treemap para 2008T1 (sin leyenda)
grafico_treemap_2008 <- ggplot(datos_filtrados_2008, aes(area = Total_porc, fill = Total_porc, label = paste(datos_filtrados_2008$Rama.abreviada, Total_porc, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_text(aes(label = ifelse(Total_porc > 1, paste(datos_filtrados_2008$Rama.abreviada, Total_porc, sep = "\n"), "")), 
                    colour = "white", 
                    place = "centre", 
                    size = 6) + 
  labs(title = "Distribución Rama de\nActividad (2008T1)") +
  escala_color +
  guides(fill = "none")  # Elimina la leyenda del segundo gráfico

# Usamos patchwork para poner los gráficos uno al lado del otro
grafico_combinado <- grafico_treemap_2008 | grafico_treemap_2024

# Mostrar el gráfico combinado
grafico_combinado


```
Se observa cómo algunas ramas han ganado o perdido relevancia en términos de empleo total a lo largo del tiempo. Por ejemplo, sectores relacionados con la educación y la administración pública han aumentado su proporción, mientras que ramas relacionadas con la construcción y la industria han experimentado una marcada disminución.

Además de realizar un análisis comparativo de cómo se distribuye por ramas de actividad la población trabajadora, se realiza un análisis visual de la evolución del empleo en España de manera absoluta agrupando por sexo, en conjunto con un análisis de la evolución de la diferencia trimestral en el empleo. Para ello se han empleado gráficos de lineas. Estos gráficos incluyen referencias visuales a eventos históricos relevantes, como el fin de la crisis económica de 2013 y el inicio de la pandemia en 2020.

```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=3, fig.cap="Evolución del empleo en España y de las diferencias ientre dos periodos consecutivos."}
# Fin de la crisis (junio 2013) y Inicio de COVID (marzo 2020)
fin_crisis <- as.Date("2013-06-01")      
inicio_covid <- as.Date("2020-03-01")    

# Primer gráfico: Evolución del empleo en España (con leyenda)
grafico_empleo <- ggplot(datos_CNAE[datos_CNAE$Sexo != "Total" & datos_CNAE$Rama.de.actividad.CNAE.2009 == "Total", ], 
       aes(x = Periodo, y = Total_abs, color = Sexo, group = Sexo)) +
  geom_line(size=0.75) + 
  geom_point(size=1) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_text(aes(x = fin_crisis, y = max(datos_CNAE$Total_abs, na.rm = TRUE) * 0.6,
                label = "Fin de la crisis\n (2013)"), 
            color = "grey30", size = 2, fontface = "italic",
            hjust = -0.04, vjust = 0.3) +
  geom_text(aes(x = inicio_covid, y = max(datos_CNAE$Total_abs, na.rm = TRUE) * 0.6,
                label = "Inicio COVID\n (2020)"), 
            color = "grey30", size = 2, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  scale_y_continuous(labels = label_number(big.mark = ","), expand = expansion(mult = c(0, 0.05))) +
  expand_limits(y = 0) +
  labs(title = "Evolución del empleo\n(Absoluto)",
       x = "Fecha",
       y = "Total") +
  guides(color = guide_legend(position = "bottom")) +
  theme(plot.title = element_text(size = 8, face = "bold"))+
  theme( plot.title = element_text(size = 8, face = "bold"), # Ajusta el tamaño del título
         axis.title.x = element_text(size = 8), # Ajusta el tamaño del título del eje X 
         axis.title.y = element_text(size = 8) # Ajusta el tamaño del título del eje Y 
         )# Leyenda debajo

# Segundo gráfico: Evolución del empleo en España (Diferencia respecto al periodo anterior, sin leyenda)
grafico_diferencia <- ggplot(datos_CNAE[datos_CNAE$Sexo != "Total" & datos_CNAE$Rama.de.actividad.CNAE.2009 == "Total", ], 
       aes(x = Periodo, y = Diferencia_Total, color = Sexo, group = Sexo)) +
  geom_line(size=0.75) + 
  geom_point(size = 1) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_text(aes(x = fin_crisis, y = -750,
                label = "Fin de la crisis\n (2013)"), 
            color = "grey30", size = 2, fontface = "italic",
            hjust = -0.04, vjust = 0.75) +
  geom_text(aes(x = inicio_covid, y = -750,
                label = "Inicio COVID\n (2020)"), 
            color = "grey30", size = 2, fontface = "italic",
            hjust = -0.1, vjust = 0.75) +
  scale_y_continuous(labels = label_number(big.mark = ","), expand = expansion(mult = c(0, 0.05))) +
  expand_limits(y = -1200) +

  labs(title = "Evolución del empleo\n(Diferencia con periodo anterior)",
       x = "Fecha",
       y = "Diferencia en Total") +
  theme(legend.position = "none",
        plot.title = element_text(size = 8, face = "bold")) +
  theme( plot.title = element_text(size = 8, face = "bold"), # Ajusta el tamaño del título
         axis.title.x = element_text(size = 8), # Ajusta el tamaño del título del eje X 
         axis.title.y = element_text(size = 8) # Ajusta el tamaño del título del eje Y 
         )# Ajusta el tamaño del título)  # Sin leyenda

# Combinar ambos gráficos horizontalmente con patchwork
grafico_combinado <- (grafico_empleo | grafico_diferencia) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")
# Mostrar el gráfico combinado
grafico_combinado

```


Se destaca cómo el empleo masculino y femenino responden de manera diferente a los shocks económicos. Por ejemplo, los hombres experimentaron caídas más pronunciadas durante la crisis de 2008, mientras que las mujeres mostraron una recuperación más gradual. Además, se puede apreciar que la diferencia entre sexos se redujo en grán medida durante la crisis de 2008, desde la cual la población masculina ha sido incapaz de recuperar las cifras precrisis, mientras que las mujeres han superado marcadamente dichos valores.

### **Estudio de correlaciones entre Ramas de Actividad**

A continuación, se realiza un estudio de las correlaciones lineales de Pearson entre distintas ramas de actividad (en ambos sexos en conjunto). Los datos de CNAE vienen dispuestos en dos órdenes de agrupación, unos más generales, caracterizados por empezar por una letra en su nombre, y otros más concretos, empezando por un número. Es por ello que se realizan dos gráficas separadas que muestran la matriz de correlaciones entre ramas.

```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=3, fig.cap="Matriz de correlación entre agrupaciones generales de ramas de actividad."}
datos_ancho <- datos_CNAE %>%
  filter(Sexo == "Ambos sexos") %>%
  filter(grepl("^[A-Za-z]", Rama.de.actividad.CNAE.2009)) %>%  # Filtra solo aquellas que empiezan con una letra
  mutate(Total_abs = as.numeric(Total_abs)) %>%
  select(Periodo, Rama.de.actividad.CNAE.2009, Total_abs) %>%
  pivot_wider(names_from = Rama.de.actividad.CNAE.2009, values_from = Total_abs, values_fill = list(Total = 0))

# Preparamos la matriz de correlación
matriz_valores <- datos_ancho %>%
  select(-Periodo)

matriz_correlacion <- cor(matriz_valores, use = "pairwise.complete.obs", method = "pearson")
cor_melted <- melt(matriz_correlacion)

# Graficamos la matriz de correlación

  ggplot(cor_melted, aes(Var1, Var2, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
    labs(title = "Matriz de correlación entre ramas de actividad",
         x = "Rama de actividad",
         y = "Rama de actividad") +
  scale_x_discrete(labels = c("Total", LETTERS[1:(length(cor_melted$Var1)-1)])) +  # Etiquetas personalizadas para el eje X
  scale_y_discrete(labels = c("Total", LETTERS[1:(length(cor_melted$Var2)-1)])) +  # Etiquetas personalizadas para el eje Y
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  
    axis.text.y = element_text(size = 8),  
    axis.ticks = element_line(color = "gray")
  )

  #LETTERS[1:length(cor_melted$Var1)]
      #sort(colnames(datos_ancho %>% select(-Periodo, -Total)))
```

Se observa que la mayoría de las ramas parecen estar correlacionadas positivamente, salvo aquellos puestos relacionados con el personal doméstico e industrias extractivas con una correlación negativa con la mayoría de las ramas, así como aquellas relacionadas con la agricultura, ganadería, construcción, actividades financieras entre otras que no presentan una marcada correlación con el resto.

### **Tendencias relativas a partir de datos normalizados**

```{r, warning=FALSE, echo=FALSE}
ramas_individuales <- datos_CNAE[!grepl("^[A-Za-z]", datos_CNAE$Rama.de.actividad.CNAE.2009), ]
data_normalized <- ramas_individuales[ramas_individuales$Sexo=="Ambos sexos",] %>%
  group_by(Rama.de.actividad.CNAE.2009) %>%
  arrange(Periodo) %>%  # Ordena por fecha dentro de cada grupo
  mutate(Primer_Total = first(Total_abs),  # Obtiene el primer valor de Total
         Total_Normalizado = ifelse(Primer_Total == 0, Primer_Total, Total_abs / Primer_Total)) %>%  # Normaliza dividiendo por el primer valor
  ungroup()  # Desagrupa al final
```

En este punto, se busca estudiar las tendencias relativas, eliminando la influencia de las diferencias inciales entre ramas. Para ello, primero se normalizan los datos dividiendo por el número inicial de trabajadores en cada rama, y a continuación se obtiene una métrica de distancia entre dichos datos normalizados, obteniéndose como la media de las diferencias absolutas de las cantidades normalizadas. A partir de estas distancias, se proyectan en dos dimensiones utilizando MDS, lo que permite visualizar las relaciones entre ramas en función de sus patrones de empleo a lo largo del tiempo. La proyección MDS es escogida frente a otros métodos debido a su enfoque en conservar las distancias establecidas.

```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=2, fig.cap="Proyección MDS de las distancias entre la evolución de ramas de actividad normalizadas."}
data_wide <- data_normalized %>%
  select(Rama.de.actividad.CNAE.2009, Periodo, Total_Normalizado) %>%  # Seleccionar las columnas necesarias
  pivot_wider(names_from = Periodo, values_from = Total_Normalizado, values_fill = 0)
data_wide <- na.omit(data_wide)

diferencias <- data_wide %>%
  select(-Rama.de.actividad.CNAE.2009) %>%  # Excluir la columna de Rama
  as.matrix() 

distancias_matriz <- dist(diferencias, method = "euclidean")

distancias_matriz <- as.matrix(distancias_matriz)

rownames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009
colnames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009

mds_result <- cmdscale(distancias_matriz, k = 2)

mds_data <- as.data.frame(mds_result)

nombres_actividades <- colnames(distancias_matriz)

mds_data$Rama <- nombres_actividades

grafica_mds <- ggplot(mds_data, aes(x = V1, y = V2, label = Rama)) +
  geom_point(color = "blue") +
  labs(title = "Proyección MDS de actividades por medias de diferencias\nentre datos normalizados",
       x = "Dimensión 1", y = "Dimensión 2")
grafica_mds
```

Se forman agrupaciones naturales de ramas con patrones similares. Además, se observan claramente algunos outliers, que puede ser de gran interés analizarlos individualmente.

```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=3, fig.cap="Evolución de la tasa de actividad en España"}
# Primer gráfico
plot1 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "09 Actividades de apoyo a las industrias extractivas", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1) +
  labs(
    subtitle = "Apoyo a industrias\nextractivas", 
    y = "Total"  # Etiqueta en eje y
  ) +
  theme(legend.position = "none")  # Ocultar la leyenda en este gráfico

# Segundo gráfico
plot2 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "07 Extracción de minerales metálicos", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1) +
  labs(
    subtitle = "Extracción de\nminerales metálicos", 
    y = "Total"  # Etiqueta en eje y
  )

# Tercer gráfico
plot3 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "99 Actividades de organizaciones y organismos extraterritoriales", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1) +
  labs(
    subtitle = "Org. y organismos\nextraterritoriales", 
    y = "Total"  # Etiqueta en eje y
  )

# Combinar los gráficos con un título general y una leyenda compartida
combined_plot <- (plot1 | plot2 | plot3) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")+
  theme( plot.title = element_text(size = 8, face = "bold"), # Ajusta el tamaño del título
         axis.title.x = element_text(size = 8), # Ajusta el tamaño del título del eje X 
         axis.title.y = element_text(size = 8) # Ajusta el tamaño del título del eje Y 
         )


# Mostrar el gráfico combinado
print(combined_plot)

```

Ramas como "Extracción de minerales metálicos", "Actividades de apoyo a las industrias extractivas" o "Actividades de organizaciones y organismos extraterritoriales" se destacan por su comportamiento atípico. Estas ramas tienen una dinámica de empleo inusual debido a su naturaleza específica, tamaño reducido o dependencia de factores externos como la demanda global. Observamos claramente que son datos con mucho ruido, y por lo tanto es normal que nos apareciesen como outliers. 

```{r, warning=FALSE, include=FALSE}
ramas_a_eliminar <- c(
                      "07 Extracción de minerales metálicos",
                      "09 Actividades de apoyo a las industrias extractivas",
                      "99 Actividades de organizaciones y organismos extraterritoriales")
data_normalized <- data_normalized %>%
  filter(!(Rama.de.actividad.CNAE.2009 %in% ramas_a_eliminar))

data_wide <- data_normalized %>%
  select(Rama.de.actividad.CNAE.2009, Periodo, Total_Normalizado) %>%  # Seleccionar las columnas necesarias
  pivot_wider(names_from = Periodo, values_from = Total_Normalizado, values_fill = 0)
data_wide <- na.omit(data_wide)

diferencias <- data_wide %>%
  select(-Rama.de.actividad.CNAE.2009) %>%  # Excluir la columna de Rama
  as.matrix() 

distancias_matriz <- dist(diferencias, method = "euclidean")

distancias_matriz <- as.matrix(distancias_matriz)

rownames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009
colnames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009

mds_result <- cmdscale(distancias_matriz, k = 2)

mds_data <- as.data.frame(mds_result)

nombres_actividades <- colnames(distancias_matriz)

mds_data$Rama <- nombres_actividades
```


### **Clusterización por Ramas de Actividad**

Tras observar la proyección tratamos de segmentar los datos en agrupaciones naturales, es por ello que tratamos de hacer un clustering que nos permita agrupar cuantitativamente aquellas ramas de actividad que han tenido un comportamiento similar entre ellas (con los datos normalizados). Para ello se opta en primer lugar por el algoritmo más típico en clustering (k-means), y se analiza sus resultados para ver si son satisfactorios. Además, como método para la selección del hiperparámetro `k`, se opta por el método del codo. Sin embargo, este resultado se analizará para saber si es adecuado, si sería necesario alterar ligeramente el número de clusters obtenidos o si directamente deberíamos escoger otro método.




```{r, warning=FALSE, echo=FALSE, fig.align='center',fig.width=5.5, fig.height=2, fig.cap="Gráfico del método del codo y representación mediante una proyección MDS de los clusters de k-means, con el parámetro $k$ escogido."}
# Configurar semilla para reproducibilidad
set.seed(123)

# Crear un rango de posibles valores para el número de clusters
k_range <- 1:10

# Calcular el WCSS (Within-Cluster Sum of Squares) para cada valor de k
wcss <- sapply(k_range, function(k) {
  kmeans(diferencias, centers = k, nstart = 25)$tot.withinss
})

# Crear el gráfico de codo
elbow_plot <- ggplot(data.frame(K = k_range, WCSS = wcss), aes(x = K, y = WCSS)) +
  geom_line() + 
  geom_point() +
  labs(title = "Gráfico del codo",
       x = "Número de clusters (k)", y = "WCSS")

# Determinar el número de clusters y crear el modelo kmeans
num_clusters <- 3
clusters <- kmeans(diferencias, centers = num_clusters)

# Agregar la información de los clusters a los datos MDS
mds_data$Cluster <- as.factor(clusters$cluster)

# Crear el gráfico MDS
grafica_mds <- ggplot(mds_data, aes(x = V1, y = V2, color = Cluster, label = Rama)) +
  geom_point(size = 2, alpha=0.8) +
  labs(title = "Proyección MDS clusters",
       x = "Dimensión 1", y = "Dimensión 2")

# Combinar los gráficos con patchwork
combined_plot <- elbow_plot + grafica_mds + plot_layout(ncol = 2)

# Mostrar el gráfico combinado
combined_plot

```

El método del codo parece indicarnos que la mejor selección es $k=3$ y observamos que los resultados parecen satisfactorios. Por lo tanto, debido a la simplicidad del modelo nos quedamos con esta elección. Pasamos a estudiar por separado el comportamiento de cada cluster y trataremos de averiguar si tienen una interpretación natural clara.

```{r, warning=FALSE, echo=FALSE, fig.align='center', fig.width=5.5, fig.height=3, fig.cap="Evolución de los percentiles 25, 50, 75 y media de la evolución normalizada agrupados por clúster."}
# Suponiendo que tienes los datos en data_wide y mds_data como antes.

# Procesamiento de datos
data_wide$Cluster <- as.factor(mds_data$Cluster)

# Asegúrate de que Periodo esté en formato de fecha
data_long <- data_wide %>%
  pivot_longer(-c(Rama.de.actividad.CNAE.2009, Cluster), names_to = "Periodo", values_to = "Total_Normalizado") %>%
  mutate(Periodo = as.Date(Periodo, format = "%Y-%m-%d"))  # Convierte Periodo a formato de fecha

# Agrupar por Cluster y Periodo, calcular la media y los cuantiles
cuantiles_y_media_por_cluster <- data_long %>%
  group_by(Cluster, Periodo) %>%
  summarise(
    Media = mean(Total_Normalizado, na.rm = TRUE),
    Cuantil_25 = quantile(Total_Normalizado, 0.25, na.rm = TRUE),
    Cuantil_50 = quantile(Total_Normalizado, 0.50, na.rm = TRUE),
    Cuantil_75 = quantile(Total_Normalizado, 0.75, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(Media, Cuantil_25, Cuantil_50, Cuantil_75), 
               names_to = "Cuantil", values_to = "Valor")

# Crear el gráfico con facet_wrap en 2x2 (2 columnas y 2 filas)
grafico_combinado <- ggplot(cuantiles_y_media_por_cluster, aes(x = Periodo, y = 100 * Valor, color = Cluster, group = interaction(Cluster, Cuantil))) +
  geom_line(size = 0.9) +
  geom_point(size = 1) +
  facet_wrap(~ Cuantil, ncol = 2, nrow = 2, scales = "free_y", 
             labeller = as_labeller(c("Media" = "Media", "Cuantil_25" = "Percentil 25", 
                                      "Cuantil_50" = "Percentil 50", "Cuantil_75" = "Percentil 75"))) +
  labs(title = "Total Normalizado por Cluster a lo Largo del Tiempo",
       x = "Año", y = "Valor (%)") +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +  # Muestra solo los años
  scale_y_continuous(limits = c(0, 220)) +  # Limita el eje Y de 0 a 220
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Ajusta la orientación de las fechas
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.background = element_rect(fill = "white"),
    strip.background = element_rect(fill = "gray90"),
    strip.text = element_text(size = 12, face = "bold", color = "black"),
    axis.text.x = element_text(size = 6.25), # Ajusta el tamaño de los ticks en el eje X 
    axis.text.y = element_text(size = 6.25)
  )

# Mostrar el gráfico combinado
grafico_combinado


```

```{r, echo=FALSE}
# Agrupar las ramas por cluster y seleccionar las primeras tres ramas por cluster
tabla_ramas <- data_wide %>%
  group_by(Cluster) %>%
  summarise(
    Ramas = paste(head(unique(Rama.de.actividad.CNAE.2009), 3), collapse = "; "), 
    .groups = 'drop'
  )

# Mostrar la tabla con kable
#kable(tabla_ramas, col.names = c("Cl.", "Primeras tres Ramas de Actividad"), 
#      caption = "Ramas de actividad más representativas por cluster")
```

Analizando los cuantiles y medias de cada clúster, se observa que se agrupan según rendimiento, cosa ya esperada proviniendo de la métrica definida. Se observa que la mayoría de las ramas de actividad se acumulan en los clústeres con la evolución negativa o mediocre, en los cuales ha habido un decrecimiento (clúster 2) o estancamiento (clúster 3) de los trabajadores. Por otra parte el clúster 1 parece presentar ramas con resultados positivos, aunque con menor número de ramas que los anteriores.

Podemos observar que aquellos sectores relacionados con la descontaminación o la programación y la informática han avanzado mucho en los últimos años. Mientras que los sectores más relacionados con la construcción han caido fuertemente. Sin embargo, la conclusión general es que la evolución del empleo en España durante los últimos años ha sido marcadamente negativa para la mayoría de las ramas de actividad, salvandose de ella ejemplos muy concretos.