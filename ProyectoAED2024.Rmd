---
title: 'Análisis del mercado laboral en España'
author:
  - name: Catret Ruber, Pablo
    affil: 1
  - name: Palazón Caballero, José Miguel
    affil: 1,*
  - name: Rosique Martínez, Marcos
    affil: 1
affiliation:
  - num: 1
    address: |
      Universitat de València - 
      Escola Tècnica Superior d'Enginyeria (ETSE)
      Avinguda de l'Universitat, 46100 Burjassot, Valencia
    
# author citation list in chicago format
authorcitation: |
  Catret Ruber, P.; Palazón Caballero, J.M.; Rosique Martínez, M.
correspondence: |
  jomipaca@alumni.uv.es.
# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |
  A single paragraph of about 200 words maximum. For research articles, 
  abstracts should give a pertinent overview of the work. We strongly encourage
  authors to use the following style of structured abstracts, but without 
  headings: 1) Background: Place the question addressed in a broad context and
  highlight the purpose of the study; 2) Methods: Describe briefly the main
  methods or treatments applied; 3) Results: Summarize the article's main 
  findings; and 4) Conclusion: Indicate the main conclusions or interpretations. 
  The abstract should be an objective representation of the article, it must not 
  contain results which are not presented and substantiated in the main text and 
  should not exaggerate the main conclusions.
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).
bibliography: mybibfile.bib
#appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r, include=FALSE}
if(!require(knitr)) install.packages("knitr")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(plotly)) install.packages("plotly")
if(!require(readr)) install.packages("readr")
if(!require(sf)) install.packages("sf")
if(!require(patchwork)) install.packages("patchwork")
if(!require(stats)) install.packages("stats")
if(!require(treemapify)) install.packages("treemapify")
if(!require(reshape2)) install.packages("reshape2")
if(!require(scales)) install.packages("scales")
if(!require(transformr)) install.packages("transformr")
if(!require(gganimate)) install.packages("gganimate")
if(!require(visdat)) install.packages("visdat")

# Cargar funciones desde el archivo functions.r
source("functions.r")
```

# Introducción

El mercado laboral en España es un sistema complejo y dinámico que refleja las interacciones entre diversos factores económicos, sociales y demográficos. Este trabajo de análisis exploratorio de datos combina dos pilares fundamentales para entender las dinámicas laborales: la Encuesta de Población Activa (EPA) y la Clasificación Nacional de Actividades Económicas (CNAE-2009). A través de estas fuentes, se busca ofrecer una visión integral de las tasas de empleo, actividad y ocupación, desglosadas por género, grupo de edad y comunidad autónoma, así como por ramas de actividad económica.

La EPA, realizada trimestralmente por el Instituto Nacional de Estadística (INE), proporciona información detallada sobre la participación laboral de la población, permitiendo analizar las diferencias en el acceso al empleo según el género, la edad y el territorio. En esta parte del estudio, se examinan las tasas del mercado laboral en las distintas comunidades autónomas y cómo estas se ven influenciadas por eventos como la crisis financiera de 2008 o la pandemia de COVID-19. Además, se busca identificar desigualdades estructurales y dinámicas regionales que puedan servir como base para estudios más específicos o el diseño de políticas públicas.

Por otro lado, la CNAE-2009 aporta un marco estándar para clasificar las actividades económicas en las que se desempeñan los trabajadores, permitiendo analizar cómo se distribuye la fuerza laboral entre diferentes sectores. Este enfoque complementario permite explorar no solo el "dónde" y "quién" trabaja, sino también el "en qué" trabaja la población, revelando patrones de especialización sectorial y el impacto de la transformación económica a lo largo de los años.

La combinación de ambas perspectivas —la distribución demográfica y regional desde la EPA y la estructura sectorial desde la CNAE— permite abordar preguntas clave sobre el mercado laboral, tales como:

- ¿Cómo varía la participación laboral entre comunidades autónomas?
- ¿Cómo varía la participación laboral entre grupos de edad?
- ¿Qué sectores han experimentado los mayores cambios tras eventos históricos como la crisis de 2008 o la pandemia de COVID-19?

Este análisis exploratorio busca no solo describir el estado actual del mercado laboral en España, sino también identificar tendencias, desigualdades y oportunidades de mejora. El objetivo final es proporcionar una base sólida para futuros estudios y contribuir al diseño de estrategias efectivas en el ámbito económico, social y político.


# Importación y tratamiento de datos

En primer lugar, se han descargado los datos directamente desde la base de datos abierta INE Base. Estos datos se presentan en un formato de csv, separado por el carácter ';', y con el uso de marca de decimales española ','.

## Encuesta de Población Activa (EPA)

Como se ha mencionado anteriormente en la introducción, la EPA es realizada trimestralmente por el Instituto Nacional de Estadística, por lo que se han extraído cinco datasets de su base de datos: población total, activa, inactiva, ocupada y parada. 

Cabe destacar que estos datasets están desglosados por comunidad y ciudad autónoma, sexo y grupo de edad, con las tres columnas expresadas en "miles de personas" como unidad. El periodo de los datos figura desde el primer trismestre de 2002 hasta el tercer trimestre de 2024.

```{r, warning=FALSE, include=FALSE}
Poblacion <- read_delim("data/Poblacion Total.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

Activos <- read_delim("data/Activos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Activos <- Activos %>% rename(`Activos` = `Total`)

Inactivos <- read_delim("data/Inactivos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Inactivos <- Inactivos %>% rename(`Inactivos` = `Total`)

Ocupados <- read_delim("data/Ocupados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Ocupados <- Ocupados %>% rename(`Ocupados` = `Total`)

Parados <- read_delim("data/Parados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Parados <- Parados %>% rename(`Parados` = `Total`)
```

Al tratarse de un análisis del mercado laboral eliminaremos al grupo de población menor a 16 años pues no tienen edad suficiente para trabajar. Notamos que en el dataset Población hay una columna que solo contiene la cadena "Total Nacional", por lo que la eliminamos. Además, en la columna "Comunidades y Ciudades Autónomas" hay valores faltantes que coinciden con las filas del propio Total Nacional, de modo que los completamos con dicha cadena.

```{r}
Poblacion_edad_trabajar <- Poblacion %>%
  rename(`Población en edad de trabajar` = `Total`) %>%
  filter(Edad != "Menores de 16") %>%
  select(-contains("Total Nacional")) %>%
  mutate(`Comunidades y Ciudades Autónomas` =
           replace_na(`Comunidades y Ciudades Autónomas`, "Total Nacional"))
```

Notamos que para el conjunto de datos de población total en edad de trabajar y población inactiva hay un intervalo de edad más que para el resto de datasets: se divide l"55 y más años" en los grupos "De 55 a 64 años" y "65 y más años". Dado que buscamos obtener un dataset único y compacto uniremos ambos grupos de edad como en el resto de datasets.

```{r}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Población en edad de trabajar` = 
              sum(`Población en edad de trabajar`, na.rm = TRUE), .groups = 'drop')

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Inactivos` = sum(`Inactivos`, na.rm = TRUE), .groups = 'drop')
```

Una vez hemos normalizado la estructura de los datasets podemos unificar todos los datos en uno solo.

```{r}
datos_EPA <- left_join(Poblacion_edad_trabajar, Activos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Inactivos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Ocupados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Parados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo"))
```

Observamos que los datos de la columna "Periodo" son cadenas; para solucionarlo, definimos y empleamos la función "SacarFechas" para transformarlos a tipo Date.

```{r}
datos_EPA$Periodo <- as.Date(sapply(datos_EPA$Periodo, sacarFechas), 
                             format = "%Y-%m-%d")
```

```{r, include=FALSE}
# Borramos los datasets innecesarios
rm(list = c("Poblacion", "Poblacion_edad_trabajar", "Activos", "Inactivos", 
            "Ocupados", "Parados"))
```

Observemos si existen datos faltantes en nuestro dataset.

```{r}
sapply(datos_EPA, function(x) sum(is.na(x)))
```

Existe únicamente un porcentaje muy bajo de valores faltantes entre las columnas "Activos", "Ocupados" y "Parados". Veamos un ejemplo de estos casos.


```{r}
miss_datos_EPA <- datos_EPA %>% mutate(miss_parados = is.na(Parados)) %>% 
  mutate(miss_ocupados = is.na(Ocupados)) %>%
  mutate(miss_activos = is.na(Activos)) %>%
  filter(miss_parados == TRUE | miss_ocupados == TRUE | miss_activos == TRUE)
lapply(miss_datos_EPA[,c("Comunidades y Ciudades Autónomas", "Edad")], table)
```

Los datos se concentran en Comunidades y Ciudades Autónomas con proporcionalmente poca población y en rangos de edades donde es poco habitual estar parado (ya que para que se cumpla dicha condición se debe estar buscando activamente trabajo). De hecho, el único valor que podría resultar extraño es que exista un valor faltante para un Total de edades, pero al comprobar la localización y fecha notamos que es razonable.

```{r}
miss_datos_EPA[miss_datos_EPA$Edad == "Total",
               c("Sexo", "Comunidades y Ciudades Autónomas", "Periodo")]
```

```{r, include=FALSE}
rm(list=c("miss_datos_EPA"))
```

Dicho patrón parece reflejar que muy poca población de esas características se encontraba parada; por tanto, sustituiremos los valores faltantes del dataset por ceros.

```{r, include=FALSE}
datos_EPA <- datos_EPA %>% 
  mutate(Parados = ifelse(is.na(Parados), 0, Parados)) %>%
  mutate(Ocupados = ifelse(is.na(Ocupados), 0, Parados)) %>%
  mutate(Activos = ifelse(is.na(Activos), 0, Parados))
```

## Clasificación Nacional de Actividades Económicas (CNAE-2009)

Este dataset divide los datos según rama de actividad, sexo y fecha en el periodo comprendido entre el primer trimestre de 2008 y el tercer trimestre de 2024, usando las mismas unidades que en el resto de datasets. No obstante, en este caso podemos encontrar los datos segmentado en dos subconjuntos principales:

· Porcentajes ("Total_abs"): Representan la proporción de ocupación de cada rama de actividad con respecto al total del sexo correspondiente.
· Valores absolutos ("Total_porc"): Proporcionan el número total de empleados en cada rama.

Esta separación permite analizar tanto las tendencias globales (valores absolutos) como la estructura relativa de los sectores (porcentajes).

```{r, include=FALSE}
datos_CNAE <- read.csv("data/CNAE.csv", sep=";", dec=",")
datos_CNAE$Total <- as.numeric(gsub(",", ".", gsub("\\.", "", datos_CNAE$Total)))
```

Nos encontramos de nuevo con el problema del formato de las fechas, por lo que volveremos a aplicar la función SacarFechas. Además, para diferenciar entre cada tipo de dato (valor absoluto y porcentaje) vamos a extraerlos en dos datasets para posteriormente realizar un join, esencialmente como si se realizara un pivote.

```{r, include=FALSE}
datos_CNAE$Periodo <- as.Date(sapply(datos_CNAE$Periodo, sacarFechas), format = "%Y-%m-%d")
```

```{r}
datos_CNAE_porc <- datos_CNAE[datos_CNAE$Unidad=="Porcentaje",]
datos_CNAE_porc <- datos_CNAE_porc[, !names(datos_CNAE_porc) %in% "Unidad"]

datos_CNAE_abs <- datos_CNAE[datos_CNAE$Unidad=="Valor absoluto",]
datos_CNAE_abs <- datos_CNAE_abs[, !names(datos_CNAE_abs) %in% "Unidad"]

if (dim(datos_CNAE_abs)[1] == dim(datos_CNAE_porc)[1] & dim(datos_CNAE_abs)[2] == dim(datos_CNAE_porc)[2]){
  datos_CNAE <- left_join(datos_CNAE_abs, datos_CNAE_porc, 
                      by = c("Rama.de.actividad.CNAE.2009", "Sexo", "Periodo"), 
                      suffix = c("_abs", "_porc"))
}
```

```{r, include=FALSE}
rm(list = c("datos_CNAE_abs", "datos_CNAE_porc"))
```

Una vez tenemos la tabla unificada es recomendable realizar un análisis de datos faltantes.

```{r}
sapply(datos_CNAE, function(x) sum(is.na(x)))
```

Observamos que para un pequeño subconjunto de filas no existen cifras totales. Veamos si siguen algún patrón.

```{r}
miss_datos_CNAE <- datos_CNAE %>% mutate(miss_total = is.na(Total_abs)) %>% 
  filter(miss_total == TRUE)
head(unique(miss_datos_CNAE$Rama.de.actividad.CNAE.2009), 4)
rm(list=c("miss_datos_CNAE"))
```

Notamos que los valores faltantes se encuentran en ramas de actividades poco comunes relacionadas con la industria pesada, por lo que dichos NA reflejarán que muy poca población se dedica a ello, probablemente menos del mínimo registrable; en consecuencia sustituiremos dichos valores por ceros.

```{r, include=FALSE}
datos_CNAE <- datos_CNAE %>% 
  mutate(Total_abs = ifelse(is.na(Total_abs), 0, Total_abs)) %>% 
  mutate(Total_porc = ifelse(is.na(Total_porc), 0, Total_porc))
```

Por último, añadiremos una columna que calcula la variación entre un periodo y el siguiente, lo que permitirá identificar momentos de cambio significativo en el mercado laboral, detectando tendencias positivas o negativas a lo largo del tiempo. Esto también permitirá ver de manera rápida la estacionalidad de la ocupación, sobre todo en ciertas ramas de actividad.

Es importante mencionar que realizar las diferencias entre un periodo y el siguiente genera NAs para el primer periodo de cada rama, por lo que sustituiremos estos valores faltantes por ceros.

```{r}
datos_CNAE$Diferencia_Total <- NA

for (sexo in unique(datos_CNAE$Sexo)) {
  for (rama in unique(datos_CNAE$Rama.de.actividad.CNAE.2009)) {
    subset <- datos_CNAE[datos_CNAE$Sexo == sexo & 
                        datos_CNAE$Rama.de.actividad.CNAE.2009 == rama, ]
    
    datos_CNAE$Diferencia_Total[datos_CNAE$Sexo == sexo & 
              datos_CNAE$Rama.de.actividad.CNAE.2009 == rama 
             & datos_CNAE$Periodo != min(datos_CNAE$Periodo)] <- 
      diff(subset$Total_abs)
  }
}

datos_CNAE$Diferencia_Total[datos_CNAE$Periodo == min(datos_CNAE$Periodo)] <- 0
```

```{r, include=FALSE}
rm(list = c("subset"))
```


