---
title: 'Análisis del mercado laboral en España'
author:
  - name: Catret Ruber, Pablo
    affil: 1
  - name: Palazón Caballero, José Miguel
    affil: 1,*
  - name: Rosique Martínez, Marcos
    affil: 1
affiliation:
  - num: 1
    address: |
      Universitat de València - 
      Escola Tècnica Superior d'Enginyeria (ETSE)
      Avinguda de l'Universitat, 46100 Burjassot, Valencia
    
# author citation list in chicago format
authorcitation: |
  Catret Ruber, P.; Palazón Caballero, J.M.; Rosique Martínez, M.
correspondence: |
  jomipaca@alumni.uv.es.
# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |
  A single paragraph of about 200 words maximum. For research articles, 
  abstracts should give a pertinent overview of the work. We strongly encourage
  authors to use the following style of structured abstracts, but without 
  headings: 1) Background: Place the question addressed in a broad context and
  highlight the purpose of the study; 2) Methods: Describe briefly the main
  methods or treatments applied; 3) Results: Summarize the article's main 
  findings; and 4) Conclusion: Indicate the main conclusions or interpretations. 
  The abstract should be an objective representation of the article, it must not 
  contain results which are not presented and substantiated in the main text and 
  should not exaggerate the main conclusions.
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).
bibliography: mybibfile.bib
#appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r, include=FALSE}
if(!require(knitr)) install.packages("knitr")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(plotly)) install.packages("plotly")
if(!require(readr)) install.packages("readr")
if(!require(sf)) install.packages("sf")
if(!require(patchwork)) install.packages("patchwork")
if(!require(stats)) install.packages("stats")
if(!require(treemapify)) install.packages("treemapify")
if(!require(reshape2)) install.packages("reshape2")
if(!require(scales)) install.packages("scales")
if(!require(transformr)) install.packages("transformr")
if(!require(gganimate)) install.packages("gganimate")
if(!require(visdat)) install.packages("visdat")
if(!require(stringr)) install.packages("stringr")

# Cargar funciones desde el archivo functions.r
source("functions.r")
```

# Introducción

El mercado laboral en España es un sistema complejo y dinámico que refleja las interacciones entre diversos factores económicos, sociales y demográficos. Este trabajo de análisis exploratorio de datos combina dos pilares fundamentales para entender las dinámicas laborales: la Encuesta de Población Activa (EPA) y la Clasificación Nacional de Actividades Económicas (CNAE-2009). A través de estas fuentes, se busca ofrecer una visión integral de las tasas de empleo, actividad y ocupación, desglosadas por género, grupo de edad y comunidad autónoma, así como por ramas de actividad económica.

La EPA, realizada trimestralmente por el Instituto Nacional de Estadística (INE), proporciona información detallada sobre la participación laboral de la población, permitiendo analizar las diferencias en el acceso al empleo según el género, la edad y el territorio. En esta parte del estudio, se examinan las tasas del mercado laboral en las distintas comunidades autónomas y cómo estas se ven influenciadas por eventos como la crisis financiera de 2008 o la pandemia de COVID-19. Además, se busca identificar desigualdades estructurales y dinámicas regionales que puedan servir como base para estudios más específicos o el diseño de políticas públicas.

Por otro lado, la CNAE-2009 aporta un marco estándar para clasificar las actividades económicas en las que se desempeñan los trabajadores, permitiendo analizar cómo se distribuye la fuerza laboral entre diferentes sectores. Este enfoque complementario permite explorar no solo el "dónde" y "quién" trabaja, sino también el "en qué" trabaja la población, revelando patrones de especialización sectorial y el impacto de la transformación económica a lo largo de los años.

La combinación de ambas perspectivas —la distribución demográfica y regional desde la EPA y la estructura sectorial desde la CNAE— permite abordar preguntas clave sobre el mercado laboral, tales como:

- ¿Cómo varía la participación laboral entre comunidades autónomas?
- ¿Cómo varía la participación laboral entre grupos de edad?
- ¿Qué sectores han experimentado los mayores cambios tras eventos históricos como la crisis de 2008 o la pandemia de COVID-19?

Este análisis exploratorio busca no solo describir el estado actual del mercado laboral en España, sino también identificar tendencias, desigualdades y oportunidades de mejora. El objetivo final es proporcionar una base sólida para futuros estudios y contribuir al diseño de estrategias efectivas en el ámbito económico, social y político.


# Importación y tratamiento de datos

En primer lugar, se han descargado los datos directamente desde la base de datos abierta INE Base. Estos datos se presentan en un formato de csv, separado por el carácter ';', y con el uso de marca de decimales española ','.

## Encuesta de Población Activa (EPA)

Como se ha mencionado anteriormente en la introducción, la EPA es realizada trimestralmente por el Instituto Nacional de Estadística, por lo que se han extraído cinco datasets de su base de datos: población total, activa, inactiva, ocupada y parada. 

Cabe destacar que estos datasets están desglosados por comunidad y ciudad autónoma, sexo y grupo de edad, con las tres columnas expresadas en "miles de personas" como unidad. El periodo de los datos figura desde el primer trismestre de 2002 hasta el tercer trimestre de 2024.

```{r, warning=FALSE, include=FALSE}
Poblacion <- read_delim("data/Poblacion Total.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

Activos <- read_delim("data/Activos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Activos <- Activos %>% rename(`Activos` = `Total`)

Inactivos <- read_delim("data/Inactivos.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Inactivos <- Inactivos %>% rename(`Inactivos` = `Total`)

Ocupados <- read_delim("data/Ocupados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Ocupados <- Ocupados %>% rename(`Ocupados` = `Total`)

Parados <- read_delim("data/Parados.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Total = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)
Parados <- Parados %>% rename(`Parados` = `Total`)
```

Al tratarse de un análisis del mercado laboral eliminaremos al grupo de población menor a 16 años pues no tienen edad suficiente para trabajar. Notamos que en el dataset Población hay una columna que solo contiene la cadena "Total Nacional", por lo que la eliminamos. Además, en la columna "Comunidades y Ciudades Autónomas" hay valores faltantes que coinciden con las filas del propio Total Nacional, de modo que los completamos con dicha cadena.

```{r, include=FALSE}
Poblacion_edad_trabajar <- Poblacion %>%
  rename(`Población en edad de trabajar` = `Total`) %>%
  filter(Edad != "Menores de 16") %>%
  select(-contains("Total Nacional")) %>%
  mutate(`Comunidades y Ciudades Autónomas` =
           replace_na(`Comunidades y Ciudades Autónomas`, "Total Nacional"))
```

Notamos que para el conjunto de datos de población total en edad de trabajar y población inactiva hay un intervalo de edad más que para el resto de datasets: se divide l"55 y más años" en los grupos "De 55 a 64 años" y "65 y más años". Dado que buscamos obtener un dataset único y compacto uniremos ambos grupos de edad como en el resto de datasets. Una vez normalizada la estructura de los datasets podemos unificar todas las tablas en una sola.

```{r, include=FALSE}
Poblacion_edad_trabajar <- Poblacion_edad_trabajar %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Población en edad de trabajar` = 
              sum(`Población en edad de trabajar`, na.rm = TRUE), .groups = 'drop')

Inactivos <- Inactivos %>%
  mutate(Edad = ifelse(Edad %in% c("De 55 a 64 años", "65 y más años"), 
                       "55 y más años", Edad)) %>%
  group_by(Sexo, `Comunidades y Ciudades Autónomas`, Edad, Periodo) %>%
  summarise(`Inactivos` = sum(`Inactivos`, na.rm = TRUE), .groups = 'drop')
```

```{r, include=FALSE}
datos_EPA <- left_join(Poblacion_edad_trabajar, Activos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Inactivos, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Ocupados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo")) %>%
                left_join(., Parados, 
      by=c("Sexo", "Comunidades y Ciudades Autónomas", "Edad", "Periodo"))
```

Otra circunstancia a corregir que los datos de la columna "Periodo" son cadenas; para solucionarlo, definimos y empleamos la función "SacarFechas" para transformarlos a tipo Date. Una vez corregido, comprobaremos si existen datos faltantes en nuestro dataset.

```{r, include=FALSE}
datos_EPA$Periodo <- as.Date(sapply(datos_EPA$Periodo, sacarFechas), 
                             format = "%Y-%m-%d")
```

```{r, include=FALSE}
# Borramos los datasets innecesarios
rm(list = c("Poblacion", "Poblacion_edad_trabajar", "Activos", "Inactivos", 
            "Ocupados", "Parados"))
```

```{r, echo=FALSE}
sapply(datos_EPA, function(x) sum(is.na(x)))
```

Existe únicamente un porcentaje muy bajo de valores faltantes entre las columnas "Activos", "Ocupados" y "Parados". Veamos un ejemplo de estos casos.


```{r, echo=FALSE}
miss_datos_EPA <- datos_EPA %>% mutate(miss_parados = is.na(Parados)) %>% 
  mutate(miss_ocupados = is.na(Ocupados)) %>%
  mutate(miss_activos = is.na(Activos)) %>%
  filter(miss_parados == TRUE | miss_ocupados == TRUE | miss_activos == TRUE)
lapply(miss_datos_EPA[,c("Comunidades y Ciudades Autónomas", "Edad")], table)
```

Los datos se concentran en Comunidades y Ciudades Autónomas con proporcionalmente poca población y en rangos de edades donde es poco habitual estar parado (ya que para que se cumpla dicha condición se debe estar buscando activamente trabajo). De hecho, el único valor que podría resultar extraño es que exista un valor faltante para un Total de edades, pero al comprobar la localización y fecha notamos que es razonable.

```{r, echo=FALSE}
miss_datos_EPA[miss_datos_EPA$Edad == "Total",
               c("Sexo", "Comunidades y Ciudades Autónomas", "Periodo")]
```

```{r, include=FALSE}
rm(list=c("miss_datos_EPA"))
```

Dicho patrón parece reflejar que muy poca población de esas características se encontraba parada; por tanto, sustituiremos los valores faltantes del dataset por ceros.

```{r, include=FALSE}
datos_EPA <- datos_EPA %>% 
  mutate(Parados = ifelse(is.na(Parados), 0, Parados)) %>%
  mutate(Ocupados = ifelse(is.na(Ocupados), 0, Ocupados)) %>%
  mutate(Activos = ifelse(is.na(Activos), 0, Activos))
```

## Clasificación Nacional de Actividades Económicas (CNAE-2009)

Este dataset divide los datos según rama de actividad, sexo y fecha en el periodo comprendido entre el primer trimestre de 2008 y el tercer trimestre de 2024, usando las mismas unidades que en el resto de datasets. No obstante, en este caso podemos encontrar los datos segmentado en dos subconjuntos principales:

+ Porcentajes ("Total_abs"): Representan la proporción de ocupación de cada rama de actividad con respecto al total del sexo correspondiente.

+ Valores absolutos ("Total_porc"): Proporcionan el número total de empleados en cada rama.

Esta separación permite analizar tanto las tendencias globales (valores absolutos) como la estructura relativa de los sectores (porcentajes).

```{r, include=FALSE}
datos_CNAE <- read.csv("data/CNAE.csv", sep=";", dec=",")
datos_CNAE$Total <- as.numeric(gsub(",", ".", gsub("\\.", "", datos_CNAE$Total)))
```

Nos encontramos de nuevo con el problema del formato de las fechas, por lo que volveremos a aplicar la función SacarFechas. Además, para diferenciar entre cada tipo de dato (valor absoluto y porcentaje) vamos a extraerlos en dos datasets para posteriormente realizar un join, esencialmente como si se realizara un pivote. Una vez hemos unificado la tabla es recomendable realizar un análisis de datos faltantes.

```{r, include=FALSE}
datos_CNAE$Periodo <- as.Date(sapply(datos_CNAE$Periodo, sacarFechas), format = "%Y-%m-%d")
```

```{r, include=FALSE}
datos_CNAE_porc <- datos_CNAE[datos_CNAE$Unidad=="Porcentaje",]
datos_CNAE_porc <- datos_CNAE_porc[, !names(datos_CNAE_porc) %in% "Unidad"]

datos_CNAE_abs <- datos_CNAE[datos_CNAE$Unidad=="Valor absoluto",]
datos_CNAE_abs <- datos_CNAE_abs[, !names(datos_CNAE_abs) %in% "Unidad"]

if (dim(datos_CNAE_abs)[1] == dim(datos_CNAE_porc)[1] & dim(datos_CNAE_abs)[2] == dim(datos_CNAE_porc)[2]){
  datos_CNAE <- left_join(datos_CNAE_abs, datos_CNAE_porc, 
                      by = c("Rama.de.actividad.CNAE.2009", "Sexo", "Periodo"), 
                      suffix = c("_abs", "_porc"))
}
```

```{r, include=FALSE}
rm(list = c("datos_CNAE_abs", "datos_CNAE_porc"))
```

```{r, echo=FALSE}
sapply(datos_CNAE, function(x) sum(is.na(x)))
```

Observamos que para un pequeño subconjunto de filas no existen cifras totales. Veamos si siguen algún patrón.

```{r, echo=FALSE}
miss_datos_CNAE <- datos_CNAE %>% mutate(miss_total = is.na(Total_abs)) %>% 
  filter(miss_total == TRUE)
head(unique(miss_datos_CNAE$Rama.de.actividad.CNAE.2009), 4)
```

```{r, include=FALSE}
rm(list=c("miss_datos_CNAE"))
```

Notamos que los valores faltantes se encuentran en ramas de actividades poco comunes relacionadas con la industria pesada, por lo que dichos NA reflejarán que muy poca población se dedica a ello, probablemente menos del mínimo registrable; en consecuencia sustituiremos dichos valores por ceros.

```{r, include=FALSE}
datos_CNAE <- datos_CNAE %>% 
  mutate(Total_abs = ifelse(is.na(Total_abs), 0, Total_abs)) %>% 
  mutate(Total_porc = ifelse(is.na(Total_porc), 0, Total_porc))
```

Por último, añadiremos una columna que calcula la variación entre un periodo y el siguiente, lo que permitirá identificar momentos de cambio significativo en el mercado laboral, detectando tendencias positivas o negativas a lo largo del tiempo. Esto también permitirá ver de manera rápida la estacionalidad de la ocupación, sobre todo en ciertas ramas de actividad. Es importante mencionar que realizar las diferencias entre un periodo y el siguiente genera NAs para el primer periodo de cada rama, por lo que sustituiremos estos valores faltantes por ceros.

```{r, include=FALSE}
datos_CNAE$Diferencia_Total <- NA

for (sexo in unique(datos_CNAE$Sexo)) {
  for (rama in unique(datos_CNAE$Rama.de.actividad.CNAE.2009)) {
    subset <- datos_CNAE[datos_CNAE$Sexo == sexo & 
                        datos_CNAE$Rama.de.actividad.CNAE.2009 == rama, ]
    
    datos_CNAE$Diferencia_Total[datos_CNAE$Sexo == sexo & 
              datos_CNAE$Rama.de.actividad.CNAE.2009 == rama 
             & datos_CNAE$Periodo != min(datos_CNAE$Periodo)] <- 
      - diff(subset$Total_abs)
  }
}

datos_CNAE$Diferencia_Total[datos_CNAE$Periodo == min(datos_CNAE$Periodo)] <- 0
```

```{r, include=FALSE}
rm(list = c("subset"))
```


# Representación y análisis de datos

Una vez preparados, los datos se visualizan a través de gráficos y tasas que permiten interpretar patrones, tendencias y distribuciones de manera más clara y directa.

## Encuesta de Población Activa (EPA)

Las tasas del mercado de trabajo, como la de actividad, empleo y ocupación, son fundamentales para este análisis porque permiten comparar de forma clara y estandarizada las dinámicas laborales entre comunidades autónomas y grupos poblacionales. Estas métricas facilitan el estudio de tendencias temporales y desigualdades estructurales, como las brechas de género o regionales, que no serían evidentes al observar valores absolutos. Además, su uso es clave para identificar áreas críticas y evaluar el impacto de eventos económicos, como la crisis de 2008 o la pandemia de COVID-19, en la participación laboral de la población.

Por ello, las siguientes tasas quedan incorporadas dentro del dataset anteriormente mencionado:

+ Tasa de Actividad (TA): $\frac{\text{Activos}}{\text{Población} > 16}*100$

+ Tasa de Inactividad (TI): $\frac{\text{Inactivos}}{\text{Población} > 16}*100$

+ Tasa de Ocupación (TO): $\frac{\text{Ocupados}}{\text{Población} > 16}*100$

+ Tasa de Empleo (TE): $\frac{\text{Ocupados}}{\text{Activos}}*100$

+ Tasa de Desempleo (TD): $\frac{\text{Parados}}{\text{Activos}}*100$

```{r, include=FALSE}
datos_EPA <- datos_EPA %>%
  mutate(`Tasa de Actividad` = (datos_EPA$Activos/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Inactividad` = (datos_EPA$Inactivos/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Ocupación` = (datos_EPA$Ocupados/datos_EPA$`Población en edad de trabajar`)*100) %>%
  mutate(`Tasa de Empleo` = (datos_EPA$Ocupados/datos_EPA$Activos)*100) %>%
  mutate(`Tasa de Desempleo` = (datos_EPA$Parados/datos_EPA$Activos)*100)
```

Notamos que las tasas de inactividad y desempleo no proporcionan información nueva ya que se pueden obtener mediante la de actividad y empleo respectivamente: $TI = 1 - TA$ y $TD = 1 - TE$.

```{r, include=FALSE}
inicio_crisis <- as.Date("2008-01-01")   # Inicio de la crisis (enero 2008)
fin_crisis <- as.Date("2013-06-01")      # Fin de la crisis (junio 2013)
inicio_covid <- as.Date("2020-03-01")    # Inicio de COVID (marzo 2020)
```

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
# Crear un gráfico de lineas para la Tasa de Actividad
data_filtered <- datos_EPA %>%
  filter(Sexo == "Ambos sexos" &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad == "Total")

TA <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Actividad`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 48,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 48,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 46,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


# Crear un gráfico de lineas para la Tasa de Empleo
TE <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Empleo`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 70,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 85,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 70,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


# Crear un gráfico de lineas para la Tasa de Ocupación
TO <- ggplot(data = data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_point(color = "darkblue", size = 1) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 38,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 43,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 38,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado <- TA + TE + TO +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, echo=FALSE, warning=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
# Lo hacemos en dos chunks porque el código anterior muestra por pantalla 
#una tabla que no queremos mostrar
combinado
```

La figura 1 muestra la evolución de tres indicadores clave del mercado laboral en España: la tasa de actividad, la tasa de empleo y la tasa de ocupación, desde 2002 hasta prácticamente la actualidad, reflejando periodos de estabilidad y cambios abruptos relacionados con eventos económicos y sociales. Entre 2002 y 2008, todas las tasas experimentan un crecimiento sostenido, impulsado por la bonanza económica previa a la crisis financiera global, con un auge en sectores como la construcción y los servicios, y una incorporación activa de la población al mercado laboral.

El inicio de la crisis en 2008 genera un comportamiento diferenciado: mientras que la tasa de actividad se mantiene relativamente estable hasta 2013, las tasas de empleo y ocupación muestran un descenso significativo, reflejando el impacto directo de la destrucción de empleo y la pérdida de capacidad de absorción del mercado laboral. Esto indica que, aunque muchas personas siguieron buscando trabajo activamente (evitando una caída en la actividad), el deterioro de las condiciones laborales afectó severamente las oportunidades de empleo. La tasa de empleo pasó de más del 90% a por debajo del 75% en 2013, o que es lo mismo, un desempleo de más del 25% en la población.

A partir de 2013, con los primeros signos de recuperación económica, la tasa de actividad decrece levemente, posiblemente asociada a una menor presión en el mercado laboral y una reducción del abandono escolar, mientras que las tasas de empleo y ocupación comienzan una recuperación progresiva. Este periodo refleja una estabilización del mercado laboral con la recuperación de ciertos sectores clave.

El impacto de la pandemia de COVID-19 en 2020 es evidente en todas las tasas, con caídas abruptas, especialmente en la tasa de ocupación, debido al cierre temporal de actividades económicas y restricciones de movilidad. Este impacto fue más pronunciado que el de la crisis financiera. Desde 2021, se observa una recuperación acelerada en las tres tasas, marcada por la reincorporación de trabajadores al mercado laboral y el dinamismo de sectores como los servicios digitales, el comercio y el turismo.

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Filtrar los datos para Hombres y Mujeres a nivel nacional
data_filtered <- datos_EPA %>%
  filter(Sexo %in% c("Hombres", "Mujeres") &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad == "Total")

# Calcular la diferencia entre hombres y mujeres en la Tasa de Actividad
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Actividad`[Sexo == "Hombres"] - `Tasa de Actividad`[Sexo == "Mujeres"],
            .groups = 'drop')


TA_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Actividad`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 60, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 30,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 20,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 30,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Calcular la diferencia entre hombres y mujeres en la Tasa de Empleo
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Empleo`[Sexo == "Hombres"] - `Tasa de Empleo`[Sexo == "Mujeres"],
            .groups = 'drop')


TE_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Empleo`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 100, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 30,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 40,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de lineas para cada sexo + gráfico de barras para las diferencias
# Calcular la diferencia entre hombres y mujeres en la Tasa de Ocupación
data_diff <- data_filtered %>%
  group_by(Periodo) %>%
  summarise(Diferencia = `Tasa de Ocupación`[Sexo == "Hombres"] - `Tasa de Ocupación`[Sexo == "Mujeres"],
            .groups = 'drop')


TO_sexo <- ggplot() +
  geom_line(data = data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = Sexo), size = 1) +
  geom_col(data = data_diff, aes(x = Periodo, y = Diferencia), fill = "black", alpha = 0.7) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
    colour = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "right"
  ) +
  scale_colour_manual(values = c("Hombres" = "steelblue", "Mujeres" = "darkred")) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 60, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 22,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 15,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 22,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado2 <- TA_sexo + TE_sexo + TO_sexo +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo por Sexo",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, echo=FALSE, warning=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
combinado2
```

La figura muestra la evolución de las tasas de actividad, empleo y ocupación desglosadas por género, evidenciando patrones de desigualdad, convergencia y algunas diferencias clave entre estos indicadores. La tasa de actividad masculina, consistentemente más alta que la femenina, experimenta un descenso gradual entre 2008 y 2020, probablemente vinculado a los cambios estructurales tras la crisis financiera. En contraste, la tasa de actividad femenina ha crecido de forma sostenida desde 2002, impulsada por cambios sociales y legislativos, aunque este crecimiento se ralentiza a partir de 2008. Este proceso ha reducido la brecha de género de casi un 20% en 2002 a cerca de un 8% en años recientes, como reflejan las barras grises que representan esta diferencia.

En la tasa de empleo, sin embargo, las diferencias entre hombres y mujeres son mucho más reducidas, lo que sugiere que la principal disparidad radica en la población activa. Esto se explica porque la tasa de empleo mide únicamente a las personas empleadas dentro de la población activa, mientras que la tasa de ocupación considera a toda la población en edad de trabajar. Por ello, las diferencias en la tasa de ocupación entre hombres y mujeres son más marcadas, reflejando no solo las desigualdades en el empleo, sino también las disparidades en la incorporación al mercado laboral.

Durante la pandemia de COVID-19 en 2020, todas las tasas muestran un descenso significativo, seguido de una recuperación que resalta la resiliencia del mercado laboral. Este análisis pone en evidencia tanto los avances hacia la igualdad de género en términos laborales como las áreas donde persisten desigualdades estructurales, especialmente en la población activa y su impacto en las tasas de ocupación.

```{r, warning=FALSE, include=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
# Crear un gráfico de líneas para cada grupo de edad
data_filtered <- datos_EPA %>%
  filter(Sexo == "Ambos sexos" &
           `Comunidades y Ciudades Autónomas` == "Total Nacional" &
           Edad != "Total")


TA_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Actividad`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Actividad (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 90, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 33,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 36,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de líneas para cada grupo de edad
TE_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Empleo`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Empleo (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "none"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(20, 100, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 40,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = 1.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 40,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 30,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)



# Crear un gráfico de líneas para cada grupo de edad
TO_edad <- ggplot(data_filtered, aes(x = Periodo, y = `Tasa de Ocupación`, colour = Edad, group = Edad)) +
  geom_line(size = 0.8) +
  labs(
    x = "Periodo",
    y = "Tasa de Ocupación (%)",
    colour = "Grupo de Edad",
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.position = "right"
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    breaks = seq(0, 80, by = 10)
    ) +
  
  geom_vline(xintercept = as.numeric(inicio_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  
  geom_text(aes(x = inicio_crisis, y = 30,
                label = "Inicio de la crisis\n (2008)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = fin_crisis, y = 50,
                label = "Fin de la crisis\n (2013)"), 
                color = "grey30", size = 1.8, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  geom_text(aes(x = inicio_covid, y = 50,
                label = "Inicio COVID\n (2020)" 
                ), color = "grey30", size = 1.8,fontface = "italic",
            hjust = -0.04, vjust = 0)


combinado3 <- TA_edad + TE_edad + TO_edad +
  plot_layout(ncol = 2, heights = c(1.2, 1.2)) + # Ajustar espacio entre filas
  plot_annotation(title = "Evolución de las Tasas del Mercado de Trabajo por Sexo",
                  theme = theme(plot.title = element_text(size = 14, face = "bold")))
```

```{r, warning=FALSE, echo=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
combinado3
```

Por último, desglosadando la población por grupos de edad, se puede observar cómo cada segmento ha experimentado diferentes dinámicas en el mercado laboral. Los grupos de mayor edad, como los de 35 a 44 años y 45 a 54 años, destacan por mantener tasas de actividad superiores al 80 %, significativamente más altas y estables a lo largo del tiempo, reflejando su integración consolidada en el mercado laboral. En contraste, los grupos más jóvenes, especialmente el de 16 a 19 años, presentan tasas considerablemente más bajas, con una caída pronunciada desde 2008. Por ejemplo, en 2013, la tasa de empleo de este grupo se sitúa por debajo del 30 %, lo que implica un desempleo superior al 70 %. Este fenómeno puede atribuirse a que este grupo se encontraba principalmente en el sector de la construcción, el cual sufrió más el efecto de la recesión. Por otro lado, el aumento de la escolarización y la prolongación de los estudios produjo la caída en su actividad.

Además, en los grupos jóvenes, como los de 16 a 19 años y 20 a 24 años, se observa una marcada estacionalidad a lo largo del periodo, probablemente vinculada a los meses de verano, cuando muchos estudiantes se incorporan temporalmente al mercado laboral, especialmente en sectores como la hostelería. Por su parte, en la tasa de actividad y ocupación, el grupo de 55 y más años presenta niveles considerablemente más bajos debido a la jubilación, ya que estos ciudadanos son considerados población inactiva. Sin embargo, este fenómeno no se refleja de la misma forma en la tasa de empleo, ya que este indicador se calcula en función de la población activa, excluyendo a los inactivos como los jubilados.

### Clusterización por Comunidades y Ciudades Autónomas

En este apartado del proyecto se va a proceder a realizar un clustering de la tasa de empleo para las distintas Comunidades y Ciudades Autónomas de España en los siguientes años: 2007, 2013 y 2023.
El principal motivo por el cual escogemos esta tasa se debe a que se mide como el porcentaje de personas ocupadas respecto a la población activa, es decir, las que se encuentran activamente en el mercado laboral.

Como método de clusterización se utilizará el k-means, que organiza los datos en grupos basados en su similitud. Este algoritmo comienza eligiendo un número de clusters (`k`) y seleccionando centroides iniciales al azar. Cada punto se asigna al cluster cuyo centroide está más cercano, y luego los centroides se recalculan como el promedio de los puntos en cada grupo.
Es un proceso que se repite hasta que los centroides dejan de cambiar o se alcanza un límite de iteraciones. Al finalizar, las comunidades quedan agrupadas en k clusters, representando cada uno un conjunto de puntos con características similares.

Por otro lado, como método para la selección del hiperparámetro `k` se opta por el método del codo. Este método Consiste en graficar la suma de cuadrados dentro del cluster (WSS) frente a distintos valores de `k`. El punto donde la disminución de WSS se ralentiza significativamente, formando un "codo", indica el número adecuado de clusters.

```{r, include=FALSE}
# Eliminamos el total nacional puesto que ahora nos centramos en la CCAA
datos_EPA <- datos_EPA %>%
  filter(`Comunidades y Ciudades Autónomas` != "Total Nacional") %>%
  separate(`Comunidades y Ciudades Autónomas`, into = c("Codigo", "Comunidades y Ciudades Autónomas"), sep = " ", extra = "merge")
```

```{r, include=FALSE}
# Cargamos el archivo GeoJSON
geojson_path <- "./data/spain-communities.geojson"
mapa_comunidades <- st_read(geojson_path)
```

```{r, include=FALSE}
tasas <- c("Tasa de Actividad", "Tasa de Empleo", "Tasa de Ocupación")
```


```{r, warning=FALSE, echo=FALSE, out.width='60%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
grafico_codo_global("Tasa de Empleo", datos_EPA)
```

Observando el gráfico anterior, se puede considerar que el número de clusters a partir del cual la WSS se ralentiza es en `k=3`, pues es en donde se forma el "codo".

Posteriormente, y como se ha mencionado al principio del apartado, vamos a hacer un clustering con el objetivo de agrupar las CCAA según su tasa de empleo en distintos periodos. Posteriormente los colores de los clusters se representan en un mapa de España dividido por dichas regiones para visualizar de forma clara y efectiva los patrones espaciales.

La intención de esta medida es identificar patrones regionales y analizar las diferencias en las dinámicas del mercado laboral a nivel territorial. Este enfoque permite agrupar regiones con características similares, facilitando la comparación interregional y destacando aquellas con tasas de empleo altas, medias o bajas. Además, es útil para detectar desigualdades laborales y sectoriales entre regiones comprendendiendo cómo estas evolucionan a lo largo del tiempo.

```{r, warning=FALSE, echo=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2007")
```
La figura muestra el análisis de clustering y el mapa correspondiente a la tasa de empleo de las comunidades autónomas en España en el año 2007, justo antes del inicio de la crisis financiera. En el gráfico de barras, se observa que comunidades como Navarra, Aragón, Cantabria y Cataluña presentan las tasas de empleo más altas, superando el 90%. Estas regiones, representadas en azul en el mapa, se agrupan en un mismo clúster, lo que sugiere un desempeño laboral favorable en estas áreas, posiblemente asociado a economías diversificadas y mercados laborales más sólidos tales como el tecnológico o el industrial.

Por otro lado, comunidades como Ceuta, Melilla, Extremadura y Andalucía tienen las tasas de empleo más bajas, por debajo del 85%, y se agrupan en un clúster diferenciado, marcado en rojo en el mapa. Esto refleja un mercado laboral más débil en estas regiones, históricamente caracterizadas por mayores tasas de desempleo y una dependencia económica de sectores menos dinámicos.

El clúster intermedio, representado en verde, incluye comunidades como Galicia, Castilla-La Mancha y Murcia, con tasas de empleo moderadas, entre el 85% y el 90%. Este grupo muestra un desempeño laboral estable, aunque menos destacado en comparación con las regiones líderes.

En su conjunto, la figura permite identificar con claridad las disparidades regionales en el mercado laboral español en 2007 desde el sur hasta el norte del país, proporcionando una línea base para evaluar cómo estas dinámicas se vieron afectadas por la crisis económica que comenzaría poco después.

```{r, echo=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2013")
```

Por otro lado, la figura muestra el análisis de clustering y el mapa en 2013, el momento más crítico de la crisis económica en España. En comparación con 2007, se observa una disminución generalizada de las tasas de empleo en todas las regiones, reflejando el impacto severo de la crisis en el mercado laboral. Las comunidades con tasas de empleo más altas, como País Vasco, La Rioja y Navarra, apenas superan el 70%, situándose muy por debajo de los niveles precrisis que superaban el 90%. Estas regiones, representadas en azul en el mapa, se mantienen como las de mejor desempeño relativo, aunque con una caída significativa respecto a 2007.

Las comunidades con tasas más bajas, como Andalucía, Canarias y Extremadura, presentan tasas de empleo inferiores al 60%, destacando Andalucía con un preocupante 55.5%. Este grupo, representado en rojo en el mapa, evidencia el fuerte deterioro del mercado laboral en regiones tradicionalmente más vulnerables, donde la crisis intensificó los problemas estructurales de empleo.

El clúster intermedio, en verde, agrupa comunidades como Galicia, Castilla y León, y Cataluña, con tasas de empleo entre el 63% y el 70%. Este grupo muestra una reducción importante en comparación con los niveles previos a la crisis, pero logra mantenerse en un rango moderado frente a las regiones con peor desempeño.

En conjunto, la figura refleja cómo la crisis económica impactó de manera desigual en el territorio español, exacerbando las disparidades regionales en el empleo. Aunque las regiones líderes lograron mantener una relativa ventaja, la caída generalizada evidencia la magnitud del daño económico y social provocado por la crisis. Este análisis destaca la importancia de entender las dinámicas regionales para diseñar políticas efectivas de recuperación y fortalecimiento del mercado laboral.

```{r, warning=FALSE, echo=FALSE, out.width='100%', fig.align='center', fig.cap="Evolución de la tasa de actividad en España", fig.pos="h"}
crear_clustering_grafico_mapa(datos_EPA, "Tasa de Empleo", mapa_comunidades, "2023")
```

Por último lugar, y relacionado con la actualidad, la figura de 2023 refleja una clara recuperación del mercado laboral tras los efectos de la crisis económica de 2008-2013 y la pandemia de COVID-19. Comparado con 2007, la tasa de empleo aún no alcanza los niveles previos a la crisis, pero muestra una mejora significativa respecto a 2013, lo que indica una tendencia hacia la estabilización y el fortalecimiento del empleo en el país.

En 2023, las comunidades con mejor desempeño, representadas en azul, poseen tasas de empleo que superan el 84%. Aunque aún por debajo del 90% que caracterizaba a las regiones líderes en 2007, estas comunidades han logrado una recuperación considerable desde 2013, cuando sus tasas apenas superaban el 70%.

El grupo intermedio, representado en verde, posee unos valores de empleo alrededor del 80%. Este grupo muestra una notable mejora frente a los niveles de 2013, cuando sus tasas se encontraban en torno al 65%-70%. La recuperación en estas regiones evidencia un crecimiento sostenido que les permite acercarse al desempeño de las regiones líderes.

Las comunidades con menor tasa de empleo, como Ceuta, Melilla, Andalucía y Extremadura, representadas en rojo, registran tasas por debajo del 75%. Aunque muestran avances significativos respecto a 2013, cuando sus tasas eran inferiores al 60%, estas regiones siguen siendo las más afectadas por problemas estructurales en el mercado laboral. Andalucía, por ejemplo, ha alcanzado una tasa del 74.3%, un progreso importante desde el 55.5% en 2013, pero aún distante de las regiones con mejor desempeño.

En conclusión, en comparación con 2007 el panorama de 2023 refleja un mercado laboral más o menos parecido pero con más desempleo, persistiendo también las disparidades regionales. Las comunidades más vulnerables han avanzado considerablemente, pero no han cerrado la brecha con las regiones líderes. Este análisis realizado con clustering subraya la importancia de continuar impulsando políticas orientadas a fortalecer el empleo en las regiones más rezagadas, fomentando la cohesión territorial y reduciendo las desigualdades en el mercado laboral español.


## Clasificación Nacional de Actividades Económicas (CNAE-2009)


En primer lugar se analiza la distribución de peso de las ramas de actividad en el total de la población empleada. Además, se busca comparar la evolución y el cambio sufrido por la estructura laboral española desde el primer trimestre de 2008 y el tercer trimestre de 2024. Para ello se generan treemaps para los periodos inicial (2008T1) y final (2024T3) del análisis. Estos gráficos muestran cómo se distribuye el empleo entre las diferentes ramas económicas según su peso relativo.

```{r, warning=FALSE, echo=FALSE,fig.width=8, fig.height=3}
# Filtrado de los datos para 2024T3
datos_filtrados_2024 <- na.omit(datos_CNAE[datos_CNAE$Sexo == "Ambos sexos" &
                                           datos_CNAE$Periodo == "2024-09-01" &
                                           datos_CNAE$Rama.de.actividad.CNAE.2009 != "Total" &
                                           grepl("^[0-9]", datos_CNAE$Rama.de.actividad.CNAE.2009), ])

# Filtrado de los datos para 2008T1
datos_filtrados_2008 <- na.omit(datos_CNAE[datos_CNAE$Sexo == "Ambos sexos" &
                                           datos_CNAE$Periodo == "2008-03-01" &
                                           datos_CNAE$Rama.de.actividad.CNAE.2009 != "Total" &
                                           grepl("^[0-9]", datos_CNAE$Rama.de.actividad.CNAE.2009), ])

# Crear una columna con las etiquetas recortadas solo si Total_porc < 4
datos_filtrados_2024$Rama.abreviada <- ifelse(datos_filtrados_2024$Total_porc < 4,
                                               substring(datos_filtrados_2024$Rama.de.actividad.CNAE.2009, 1, 2),
                                               str_wrap(substring(datos_filtrados_2024$Rama.de.actividad.CNAE.2009, 1, 150), width = 25))

datos_filtrados_2008$Rama.abreviada <- ifelse(datos_filtrados_2008$Total_porc < 5,
                                               substr(datos_filtrados_2008$Rama.de.actividad.CNAE.2009, 1, 2),
                                               str_wrap(substring(datos_filtrados_2008$Rama.de.actividad.CNAE.2009, 1, 150), width = 25))

# Crear una escala de colores para asegurar que ambos gráficos tengan la misma paleta
escala_color <- scale_fill_gradient(low = "lightblue", high = "darkblue")

# Primer gráfico: Treemap para 2024T3 (con leyenda)
grafico_treemap_2024 <- ggplot(datos_filtrados_2024, aes(area = Total_porc, fill = Total_porc, label = paste(datos_filtrados_2024$Rama.abreviada, Total_porc, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_text(aes(label = ifelse(Total_porc > 1, paste(datos_filtrados_2024$Rama.abreviada, Total_porc, sep = "\n"), "")), 
                    colour = "white", 
                    place = "centre", 
                    size = 8) + 
  labs(title = "Distribución Rama de Actividad (2024T3)") +
  escala_color

# Segundo gráfico: Treemap para 2008T1 (sin leyenda)
grafico_treemap_2008 <- ggplot(datos_filtrados_2008, aes(area = Total_porc, fill = Total_porc, label = paste(datos_filtrados_2008$Rama.abreviada, Total_porc, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_text(aes(label = ifelse(Total_porc > 1, paste(datos_filtrados_2008$Rama.abreviada, Total_porc, sep = "\n"), "")), 
                    colour = "white", 
                    place = "centre", 
                    size = 8) + 
  labs(title = "Distribución Rama de Actividad (2008T1)") +
  escala_color +
  guides(fill = "none")  # Elimina la leyenda del segundo gráfico

# Usamos patchwork para poner los gráficos uno al lado del otro
grafico_combinado <- grafico_treemap_2008 | grafico_treemap_2024

# Mostrar el gráfico combinado
grafico_combinado


```
Se observa cómo algunas ramas han ganado o perdido relevancia en términos de empleo total a lo largo del tiempo. Por ejemplo, sectores relacionados con la educación y la administración pública han aumentado su proporción, mientras que ramas relacionadas con la construcción y la industria han experimentado una marcada disminución.

Además de realizar un análisis comparativo de cómo se distribuye por ramas de actividad la población trabajadora, se realiza un análisis visual de la evolución del empleo en España de manera absoluta agrupando por sexo, en conjunto con un análisis de la evolución de la diferencia trimestral en el empleo. Para ello se han empleado gráficos de lineas. Estos gráficos incluyen referencias visuales a eventos históricos relevantes, como el fin de la crisis económica de 2013 y el inicio de la pandemia en 2020.

```{r, warning=FALSE, echo=FALSE,fig.width=8, fig.height=3}
library(ggplot2)
library(scales)  # Para formatear los números
library(patchwork)

# Fin de la crisis (junio 2013) y Inicio de COVID (marzo 2020)
fin_crisis <- as.Date("2013-06-01")      
inicio_covid <- as.Date("2020-03-01")    

# Primer gráfico: Evolución del empleo en España (con leyenda)
grafico_empleo <- ggplot(datos_CNAE[datos_CNAE$Sexo != "Total" & datos_CNAE$Rama.de.actividad.CNAE.2009 == "Total", ], 
       aes(x = Periodo, y = Total_abs, color = Sexo, group = Sexo)) +
  geom_line() + 
  geom_point() +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_text(aes(x = fin_crisis, y = max(datos_CNAE$Total_abs, na.rm = TRUE) * 0.6,
                label = "Fin de la crisis\n (2013)"), 
            color = "grey30", size = 3, fontface = "italic",
            hjust = -0.04, vjust = 0.3) +
  geom_text(aes(x = inicio_covid, y = max(datos_CNAE$Total_abs, na.rm = TRUE) * 0.6,
                label = "Inicio COVID\n (2020)"), 
            color = "grey30", size = 3, fontface = "italic",
            hjust = -0.04, vjust = 0) +
  scale_y_continuous(labels = label_number(big.mark = ","), expand = expansion(mult = c(0, 0.05))) +
  expand_limits(y = 0) +
  labs(title = "Evolución del empleo en España\n(Absoluto)",
       x = "Fecha",
       y = "Total") +
  guides(color = guide_legend(position = "bottom"))  # Leyenda debajo

# Segundo gráfico: Evolución del empleo en España (Diferencia respecto al periodo anterior, sin leyenda)
grafico_diferencia <- ggplot(datos_CNAE[datos_CNAE$Sexo != "Total" & datos_CNAE$Rama.de.actividad.CNAE.2009 == "Total", ], 
       aes(x = Periodo, y = Diferencia_Total, color = Sexo, group = Sexo)) +
  geom_line() + 
  geom_point() +
  geom_vline(xintercept = as.numeric(fin_crisis), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_vline(xintercept = as.numeric(inicio_covid), linetype = "dashed", color = "grey30", linewidth = 0.5) +
  geom_text(aes(x = fin_crisis, y = -750,
                label = "Fin de la crisis\n (2013)"), 
            color = "grey30", size = 3, fontface = "italic",
            hjust = -0.04, vjust = 0.75) +
  geom_text(aes(x = inicio_covid, y = -750,
                label = "Inicio COVID\n (2020)"), 
            color = "grey30", size = 3, fontface = "italic",
            hjust = -0.1, vjust = 0.75) +
  scale_y_continuous(labels = label_number(big.mark = ","), expand = expansion(mult = c(0, 0.05))) +
  expand_limits(y = -1200) +

  labs(title = "Evolución del empleo en España\n(Diferencia respecto al periodo anterior)",
       x = "Fecha",
       y = "Diferencia en Total") +
  theme(legend.position = "none")  # Sin leyenda

# Combinar ambos gráficos horizontalmente con patchwork
grafico_combinado <- (grafico_empleo | grafico_diferencia) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")
# Mostrar el gráfico combinado
grafico_combinado

```


Se destaca cómo el empleo masculino y femenino responden de manera diferente a los shocks económicos. Por ejemplo, los hombres experimentaron caídas más pronunciadas durante la crisis de 2008, mientras que las mujeres mostraron una recuperación más gradual. Además, se puede apreciar que la diferencia entre sexos se redujo en grán medida durante la crisis de 2008, desde la cual la población masculina ha sido incapaz de recuperar las cifras precrisis, mientras que las mujeres han superado marcadamente dichos valores.

### Estudio de correlaciones entre Ramas de Actividad

A continuación, se realiza un estudio de las correlaciones lineales de Pearson entre distintas ramas de actividad (en ambos sexos en conjunto). Los datos de CNAE vienen dispuestos en dos órdenes de agrupación, unos más generales, caracterizados por empezar por una letra en su nombre, y otros más concretos, empezando por un número. Es por ello que se realizan dos gráficas separadas que muestran la matriz de correlaciones entre ramas.

```{r, warning=FALSE, echo=FALSE,fig.width=8, fig.height=6}
datos_ancho <- datos_CNAE %>%
  filter(Sexo == "Ambos sexos") %>%
  filter(grepl("^[A-Za-z]", Rama.de.actividad.CNAE.2009)) %>%  # Filtra solo aquellas que empiezan con una letra
  mutate(Total_abs = as.numeric(Total_abs)) %>%
  select(Periodo, Rama.de.actividad.CNAE.2009, Total_abs) %>%
  pivot_wider(names_from = Rama.de.actividad.CNAE.2009, values_from = Total_abs, values_fill = list(Total = 0))

# Preparamos la matriz de correlación
matriz_valores <- datos_ancho %>%
  select(-Periodo)

matriz_correlacion <- cor(matriz_valores, use = "pairwise.complete.obs", method = "pearson")
cor_melted <- melt(matriz_correlacion)

# Graficamos la matriz de correlación

  ggplot(cor_melted, aes(Var1, Var2, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
    theme_minimal() +
    labs(title = "Matriz de correlación entre ramas de actividad",
         x = "Rama de actividad",
         y = "Rama de actividad") +
  scale_x_discrete(labels = c("Total", LETTERS[1:(length(cor_melted$Var1)-1)])) +  # Etiquetas personalizadas para el eje X
  scale_y_discrete(labels = c("Total", LETTERS[1:(length(cor_melted$Var2)-1)])) +  # Etiquetas personalizadas para el eje Y
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),  
    axis.text.y = element_text(size = 10),  
    axis.ticks = element_line(color = "gray")
  )

  #LETTERS[1:length(cor_melted$Var1)]
      #sort(colnames(datos_ancho %>% select(-Periodo, -Total)))
```

Se observa que la mayoría de las ramas parecen estar correlacionadas positivamente, salvo aquellos puestos relacionados con el personal doméstico e industrias extractivas con una correlación negativa con la mayoría de las ramas, así como aquellas relacionadas con la agricultura, ganadería, construcción, actividades financieras entre otras que no presentan una marcada correlación con el resto.

### Tendencias relativas a partir de datos normalizados

```{r, warning=FALSE, echo=FALSE}
ramas_individuales <- datos_CNAE[!grepl("^[A-Za-z]", datos_CNAE$Rama.de.actividad.CNAE.2009), ]
data_normalized <- ramas_individuales[ramas_individuales$Sexo=="Ambos sexos",] %>%
  group_by(Rama.de.actividad.CNAE.2009) %>%
  arrange(Periodo) %>%  # Ordena por fecha dentro de cada grupo
  mutate(Primer_Total = first(Total_abs),  # Obtiene el primer valor de Total
         Total_Normalizado = ifelse(Primer_Total == 0, Primer_Total, Total_abs / Primer_Total)) %>%  # Normaliza dividiendo por el primer valor
  ungroup()  # Desagrupa al final
```

En este punto, se busca estudiar las tendencias relativas, eliminando la influencia de las diferencias inciales entre ramas. Para ello, primero se normalizan los datos dividiendo por el número inicial de trabajadores en cada rama, y a continuación se obtiene una métrica de distancia entre dichos datos normalizados, obteniéndose como la media de las diferencias absolutas de las cantidades normalizadas. A partir de estas distancias, se proyectan en dos dimensiones utilizando MDS, lo que permite visualizar las relaciones entre ramas en función de sus patrones de empleo a lo largo del tiempo. 

```{r, warning=FALSE, echo=FALSE,fig.width=8, fig.height=3}
data_wide <- data_normalized %>%
  select(Rama.de.actividad.CNAE.2009, Periodo, Total_Normalizado) %>%  # Seleccionar las columnas necesarias
  pivot_wider(names_from = Periodo, values_from = Total_Normalizado, values_fill = 0)
data_wide <- na.omit(data_wide)

diferencias <- data_wide %>%
  select(-Rama.de.actividad.CNAE.2009) %>%  # Excluir la columna de Rama
  as.matrix() 

distancias_matriz <- dist(diferencias, method = "euclidean")

distancias_matriz <- as.matrix(distancias_matriz)

rownames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009
colnames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009

mds_result <- cmdscale(distancias_matriz, k = 2)

mds_data <- as.data.frame(mds_result)

nombres_actividades <- colnames(distancias_matriz)

mds_data$Rama <- nombres_actividades

grafica_mds <- ggplot(mds_data, aes(x = V1, y = V2, label = Rama)) +
  geom_point(color = "blue") +
  labs(title = "Proyección MDS de actividades por medias de diferencias entre datos normalizados",
       x = "Dimensión 1", y = "Dimensión 2")
grafica_mds
```

Se forman agrupaciones naturales de ramas con patrones similares. Además, se observan claramente algunos outliers, que puede ser de gran interés analizarlos individualmente.

```{r, warning=FALSE, echo=FALSE,fig.width=8, fig.height=3}
library(ggplot2)
library(patchwork)

library(ggplot2)
library(patchwork)

# Primer gráfico
plot1 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "09 Actividades de apoyo a las industrias extractivas", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1.25) +
  labs(
    subtitle = "Apoyo a industrias extractivas", 
    y = "Total"  # Etiqueta en eje y
  ) +
  theme(legend.position = "none")  # Ocultar la leyenda en este gráfico

# Segundo gráfico
plot2 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "07 Extracción de minerales metálicos", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1.25) +
  labs(
    subtitle = "Extracción de minerales metálicos", 
    y = "Total"  # Etiqueta en eje y
  )

# Tercer gráfico
plot3 <- ggplot(
  datos_CNAE[datos_CNAE$Rama.de.actividad.CNAE.2009 == 
               "99 Actividades de organizaciones y organismos extraterritoriales", ], 
  aes(x = Periodo, y = Total_abs, color = Sexo)
) +
  geom_line(size = 0.75) +
  geom_point(size = 1.25) +
  labs(
    subtitle = "Org. y organismos extraterrit.", 
    y = "Total"  # Etiqueta en eje y
  )

# Combinar los gráficos con un título general y una leyenda compartida
combined_plot <- (plot1 | plot2 | plot3) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")


# Mostrar el gráfico combinado
print(combined_plot)

```

Ramas como "Extracción de minerales metálicos", "Actividades de apoyo a las industrias extractivas" o "Actividades de organizaciones y organismos extraterritoriales" se destacan por su comportamiento atípico. Estas ramas tienen una dinámica de empleo inusual debido a su naturaleza específica, tamaño reducido o dependencia de factores externos como la demanda global. Observamos claramente que son datos con mucho ruido, y por lo tanto es normal que nos apareciesen como outliers. 

```{r, warning=FALSE, include=FALSE}
ramas_a_eliminar <- c(
                      "07 Extracción de minerales metálicos",
                      "09 Actividades de apoyo a las industrias extractivas",
                      "99 Actividades de organizaciones y organismos extraterritoriales")
data_normalized <- data_normalized %>%
  filter(!(Rama.de.actividad.CNAE.2009 %in% ramas_a_eliminar))

data_wide <- data_normalized %>%
  select(Rama.de.actividad.CNAE.2009, Periodo, Total_Normalizado) %>%  # Seleccionar las columnas necesarias
  pivot_wider(names_from = Periodo, values_from = Total_Normalizado, values_fill = 0)
data_wide <- na.omit(data_wide)

diferencias <- data_wide %>%
  select(-Rama.de.actividad.CNAE.2009) %>%  # Excluir la columna de Rama
  as.matrix() 

distancias_matriz <- dist(diferencias, method = "euclidean")

distancias_matriz <- as.matrix(distancias_matriz)

rownames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009
colnames(distancias_matriz) <- data_wide$Rama.de.actividad.CNAE.2009

mds_result <- cmdscale(distancias_matriz, k = 2)

mds_data <- as.data.frame(mds_result)

nombres_actividades <- colnames(distancias_matriz)

mds_data$Rama <- nombres_actividades
```


### Clusterización por Ramas de Actividad

Tras observar la proyección tratamos de segmentar los datos en agrupaciones naturales, es por ello que tratamos de hacer un clustering que nos permita agrupar cuantitativamente aquellas ramas de actividad que han tenido un comportamiento similar entre ellas (con los datos normalizados). Para ello se opta en primer lugar por el algoritmo más típico en clustering (k-means), y se analiza sus resultados para ver si son satisfactorios. Además, como método para la selección del hiperparámetro `k`, se opta por el método del codo. Sin embargo, este resultado se analizará para saber si es adecuado, si sería necesario alterar ligeramente el número de clusters obtenidos o si directamente deberíamos escoger otro método.

```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=3}
set.seed(123)

# Crear un rango de posibles valores para el número de clusters
k_range <- 1:10

# Calcular el WCSS (Within-Cluster Sum of Squares) para cada valor de k
wcss <- sapply(k_range, function(k) {
  kmeans(diferencias, centers = k, nstart = 25)$tot.withinss
})

# Crear el gráfico de codo
elbow_plot <- ggplot(data.frame(K = k_range, WCSS = wcss), aes(x = K, y = WCSS)) +
  geom_line() + 
  geom_point() +
  labs(title = "Gráfico de codo para determinar el número óptimo de clusters",
       x = "Número de clusters (k)", y = "WCSS")

# Mostrar el gráfico de codo
print(elbow_plot)
```


```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=3}
library(ggplot2)
library(patchwork)

# Configurar semilla para reproducibilidad
set.seed(123)

# Crear un rango de posibles valores para el número de clusters
k_range <- 1:10

# Calcular el WCSS (Within-Cluster Sum of Squares) para cada valor de k
wcss <- sapply(k_range, function(k) {
  kmeans(diferencias, centers = k, nstart = 25)$tot.withinss
})

# Crear el gráfico de codo
elbow_plot <- ggplot(data.frame(K = k_range, WCSS = wcss), aes(x = K, y = WCSS)) +
  geom_line() + 
  geom_point() +
  labs(title = "Gráfico del método del codo",
       x = "Número de clusters (k)", y = "WCSS")

# Determinar el número de clusters y crear el modelo kmeans
num_clusters <- 3
clusters <- kmeans(diferencias, centers = num_clusters)

# Agregar la información de los clusters a los datos MDS
mds_data$Cluster <- as.factor(clusters$cluster)

# Crear el gráfico MDS
grafica_mds <- ggplot(mds_data, aes(x = V1, y = V2, color = Cluster, label = Rama)) +
  geom_point(size = 2, alpha=0.8) +
  labs(title = "Proyección MDS de los datos clusterizados",
       x = "Dimensión 1", y = "Dimensión 2")

# Combinar los gráficos con patchwork
combined_plot <- elbow_plot + grafica_mds + plot_layout(ncol = 2)

# Mostrar el gráfico combinado
combined_plot

```

El método del codo parece indicarnos que la mejor selección es $k=3$ y observamos que los resultados parecen satisfactorios. Por lo tanto, debido a la simplicidad del modelo nos quedamos con esta elección. Pasamos a estudiar por separado el comportamiento de cada cluster y trataremos de averiguar si tienen una interpretación natural clara.

```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=3}
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Suponiendo que tienes los datos en data_wide y mds_data como antes.

# Procesamiento de datos
data_wide$Cluster <- as.factor(mds_data$Cluster)

# Asegúrate de que Periodo esté en formato de fecha
data_long <- data_wide %>%
  pivot_longer(-c(Rama.de.actividad.CNAE.2009, Cluster), names_to = "Periodo", values_to = "Total_Normalizado") %>%
  mutate(Periodo = as.Date(Periodo, format = "%Y-%m-%d"))  # Convierte Periodo a formato de fecha

# Agrupar por Cluster y Periodo, calcular la media y los cuantiles
cuantiles_y_media_por_cluster <- data_long %>%
  group_by(Cluster, Periodo) %>%
  summarise(
    Media = mean(Total_Normalizado, na.rm = TRUE),
    Cuantil_25 = quantile(Total_Normalizado, 0.25, na.rm = TRUE),
    Cuantil_50 = quantile(Total_Normalizado, 0.50, na.rm = TRUE),
    Cuantil_75 = quantile(Total_Normalizado, 0.75, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(Media, Cuantil_25, Cuantil_50, Cuantil_75), 
               names_to = "Cuantil", values_to = "Valor")

# Crear el gráfico con facet_wrap en 2x2 (2 columnas y 2 filas)
grafico_combinado <- ggplot(cuantiles_y_media_por_cluster, aes(x = Periodo, y = 100 * Valor, color = Cluster, group = interaction(Cluster, Cuantil))) +
  geom_line(size = 1) +
  geom_point(size = 1.25) +
  facet_wrap(~ Cuantil, ncol = 2, nrow = 2, scales = "free_y", 
             labeller = as_labeller(c("Media" = "Media", "Cuantil_25" = "Percentil 25", 
                                      "Cuantil_50" = "Percentil 50", "Cuantil_75" = "Percentil 75"))) +
  labs(title = "Total Normalizado por Cluster a lo Largo del Tiempo",
       x = "Año", y = "Valor (%)") +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +  # Muestra solo los años
  scale_y_continuous(limits = c(0, 220)) +  # Limita el eje Y de 0 a 220
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Ajusta la orientación de las fechas
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.background = element_rect(fill = "white"),
    strip.background = element_rect(fill = "gray90"),
    strip.text = element_text(size = 12, face = "bold", color = "black")
  )

# Mostrar el gráfico combinado
grafico_combinado


```




```{r, echo=FALSE}
lista_ramas_por_cluster <- data_wide %>%
  group_by(Cluster) %>%
  summarise(Ramas = list(unique(Rama.de.actividad.CNAE.2009)), .groups = 'drop')

lista_ramas <- as.list(setNames(lista_ramas_por_cluster$Ramas, lista_ramas_por_cluster$Cluster))
print(lapply(lista_ramas, function(x) head(x, 3)))
```

Analizando los cuantiles y medias de cada clúster, se observa que se agrupan según rendimiento, cosa ya esperada proviniendo de la métrica definida. Se observa que la mayoría de las ramas de actividad se acumulan en los clústeres con la evolución negativa o mediocre, en los cuales ha habido un decrecimiento (clúster 2) o estancamiento (clúster 3) de los trabajadores. Por otra parte el clúster 1 parece presentar ramas con resultados positivos, aunque con menor número de ramas que los anteriores.